<!DOCTYPE html>
<html >
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
      <title>runtime.service.executor</title>
    
          <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
          <link rel="stylesheet" href="../../../_static/theme.css " type="text/css" />
          <link rel="stylesheet" href="../../../_static/css/custom.css" type="text/css" />
      
      <!-- sphinx script_files -->
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>

      
      <!-- bundled in js (rollup iife) -->
      <!-- <script src="../../../_static/theme-vendors.js"></script> -->
      <script src="../../../_static/theme.js" defer></script>
    
  <link rel="index" title="Index" href="../../../genindex.html" />
  <link rel="search" title="Search" href="../../../search.html" /> 
  </head>

  <body>
    <div id="app">
    <div class="theme-container" :class="pageClasses"><navbar @toggle-sidebar="toggleSidebar">
  <router-link to="../../../index.html" class="home-link">
    
      <span class="site-name">Runtime</span>
    
  </router-link>

  <div class="links">
    <navlinks class="can-hide">



    </navlinks>
  </div>
</navbar>

      
      <div class="sidebar-mask" @click="toggleSidebar(false)">
      </div>
        <sidebar @toggle-sidebar="toggleSidebar">
          
          <navlinks>
            



            
          </navlinks><div id="searchbox" class="searchbox" role="search">
  <div class="caption"><span class="caption-text">Quick search</span>
    <div class="searchformwrapper">
      <form class="search" action="../../../search.html" method="get">
        <input type="text" name="q" />
        <input type="submit" value="Search" />
        <input type="hidden" name="check_keywords" value="yes" />
        <input type="hidden" name="area" value="default" />
      </form>
    </div>
  </div>
</div><div class="sidebar-links" role="navigation" aria-label="main navigation">
  
    <div class="sidebar-group">
      <p class="caption">
        <span class="caption-text"><a href="../../../index.html#runtime-documentation">Contents:</a></span>
      </p>
      <ul class="">
        
          <li class="toctree-l1 ">
            
              <a href="../../../design.html" class="reference internal ">Design Goals</a>
            

            
          </li>

        
          <li class="toctree-l1 ">
            
              <a href="../../../architecture.html" class="reference internal ">Architecture</a>
            

            
          </li>

        
          <li class="toctree-l1 ">
            
              <a href="../../../ipc.html" class="reference internal ">IPC</a>
            

            
          </li>

        
          <li class="toctree-l1 ">
            
              <a href="../../../smart-devices.html" class="reference internal ">Smart Devices</a>
            

            
          </li>

        
          <li class="toctree-l1 ">
            
              <a href="../../../api-reference/index.html" class="reference internal ">API Reference</a>
            

            
          </li>

        
      </ul>
    </div>
  
</div>
        </sidebar>

      <page>
          <div class="body-header" role="navigation" aria-label="navigation">
  
  <ul class="breadcrumbs">
    <li><a href="../../../index.html">Docs</a> &raquo;</li>
    
      <li><a href="../../index.html">Module code</a> &raquo;</li>
    
    <li>runtime.service.executor</li>
  </ul>
  

  <ul class="page-nav">
</ul>
  
</div>
<hr>
          <div class="content" role="main" v-pre>
            
  <h1>Source code for runtime.service.executor</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Student code execution.&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">abc</span>
<span class="kn">import</span> <span class="nn">asyncio</span>
<span class="kn">import</span> <span class="nn">contextlib</span>
<span class="kn">import</span> <span class="nn">functools</span>
<span class="kn">import</span> <span class="nn">importlib</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">import</span> <span class="nn">queue</span>
<span class="kn">import</span> <span class="nn">signal</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">types</span>
<span class="kn">import</span> <span class="nn">typing</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">InitVar</span><span class="p">,</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">field</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">Any</span><span class="p">,</span>
    <span class="n">Awaitable</span><span class="p">,</span>
    <span class="n">Callable</span><span class="p">,</span>
    <span class="n">Iterator</span><span class="p">,</span>
    <span class="n">Mapping</span><span class="p">,</span>
    <span class="n">NamedTuple</span><span class="p">,</span>
    <span class="n">NoReturn</span><span class="p">,</span>
    <span class="n">Optional</span><span class="p">,</span>
    <span class="n">Pattern</span><span class="p">,</span>
    <span class="n">Sequence</span><span class="p">,</span>
<span class="p">)</span>

<span class="kn">import</span> <span class="nn">structlog</span>
<span class="kn">import</span> <span class="nn">uvloop</span>

<span class="kn">from</span> <span class="nn">..</span> <span class="kn">import</span> <span class="n">api</span><span class="p">,</span> <span class="n">log</span><span class="p">,</span> <span class="n">process</span><span class="p">,</span> <span class="n">remote</span>
<span class="kn">from</span> <span class="nn">..buffer</span> <span class="kn">import</span> <span class="n">BufferStore</span>
<span class="kn">from</span> <span class="nn">..exception</span> <span class="kn">import</span> <span class="n">EmergencyStopException</span><span class="p">,</span> <span class="n">RuntimeBaseException</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;ExecutionError&#39;</span><span class="p">,</span>
    <span class="s1">&#39;ExecutionRequest&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Executor&#39;</span><span class="p">,</span>
    <span class="s1">&#39;SyncExecutor&#39;</span><span class="p">,</span>
    <span class="s1">&#39;AsyncExecutor&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Dispatcher&#39;</span><span class="p">,</span>
    <span class="s1">&#39;target&#39;</span><span class="p">,</span>
<span class="p">]</span>


<div class="viewcode-block" id="ExecutionError"><a class="viewcode-back" href="../../../api-reference/service.html#runtime.service.executor.ExecutionError">[docs]</a><span class="k">class</span> <span class="nc">ExecutionError</span><span class="p">(</span><span class="n">RuntimeBaseException</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;General execution error.&quot;&quot;&quot;</span></div>


<span class="k">def</span> <span class="nf">_handle_timeout</span><span class="p">(</span><span class="n">_signum</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">_stack_frame</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">types</span><span class="o">.</span><span class="n">FrameType</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">NoReturn</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Signal handler that raises a :class:`TimeoutError`.&quot;&quot;&quot;</span>
    <span class="k">raise</span> <span class="ne">TimeoutError</span><span class="p">(</span><span class="s1">&#39;task timed out&#39;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_handle_termination</span><span class="p">(</span>
    <span class="n">done</span><span class="p">:</span> <span class="n">threading</span><span class="o">.</span><span class="n">Event</span><span class="p">,</span>
    <span class="n">_signum</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">_frame</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">types</span><span class="o">.</span><span class="n">FrameType</span><span class="p">],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">done</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">_estop</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">NoReturn</span><span class="p">:</span>
    <span class="k">raise</span> <span class="n">EmergencyStopException</span>


<span class="k">def</span> <span class="nf">_loop_call_soon</span><span class="p">(</span>
    <span class="n">loop</span><span class="p">:</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">AbstractEventLoop</span><span class="p">,</span>
    <span class="n">callback</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
    <span class="o">/</span><span class="p">,</span>
    <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">current_loop</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">asyncio</span><span class="o">.</span><span class="n">AbstractEventLoop</span><span class="p">]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">current_loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_running_loop</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span>
        <span class="n">current_loop</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">current_loop</span> <span class="ow">is</span> <span class="n">loop</span><span class="p">:</span>
        <span class="n">loop</span><span class="o">.</span><span class="n">call_soon</span><span class="p">(</span><span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">callback</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">loop</span><span class="o">.</span><span class="n">call_soon_threadsafe</span><span class="p">(</span><span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">callback</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>


<span class="nd">@contextlib</span><span class="o">.</span><span class="n">contextmanager</span>
<span class="k">def</span> <span class="nf">using_timer</span><span class="p">(</span><span class="n">timeout</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">interval</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="o">**</span><span class="n">context</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="kc">None</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;Context manager to set, then clear, an interval timer that raises an alarm.&quot;&quot;&quot;</span>
    <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGALRM</span><span class="p">,</span> <span class="n">_handle_timeout</span><span class="p">)</span>
    <span class="n">signal</span><span class="o">.</span><span class="n">setitimer</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">ITIMER_REAL</span><span class="p">,</span> <span class="n">timeout</span><span class="p">,</span> <span class="n">interval</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">yield</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">ExecutionError</span><span class="p">(</span>
            <span class="s1">&#39;function raised an exception&#39;</span><span class="p">,</span>
            <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span>
            <span class="n">interval</span><span class="o">=</span><span class="n">interval</span><span class="p">,</span>
            <span class="o">**</span><span class="n">context</span><span class="p">,</span>
        <span class="p">)</span> <span class="kn">from</span> <span class="nn">exc</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">signal</span><span class="o">.</span><span class="n">setitimer</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">ITIMER_REAL</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">run_once</span><span class="p">(</span><span class="n">func</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Run a synchronous function once with a timeout.</span>

<span class="sd">    Raises:</span>
<span class="sd">        signal.ItimerError: If the timer was unable to be set.</span>
<span class="sd">        ExecutionError: If the callable produced an exception.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">using_timer</span><span class="p">(</span><span class="n">timeout</span><span class="p">,</span> <span class="n">func</span><span class="o">=</span><span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">run_periodically</span><span class="p">(</span>
    <span class="n">func</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
    <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="n">timeout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">predicate</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[],</span> <span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>  <span class="c1"># pragma: no cover; trivial default</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Run a synchronous function periodically.</span>

<span class="sd">    Use this function instead of calling :func:`run_once` many times. The timing will be</span>
<span class="sd">    much more regular and experience less clock drift since this function takes</span>
<span class="sd">    advantage of built-in interval timer functionality.</span>

<span class="sd">    Raises:</span>
<span class="sd">        signal.ItimerError: If the timer was unable to be set.</span>
<span class="sd">        ExecutionError: If the callable produced an exception.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">using_timer</span><span class="p">(</span><span class="n">timeout</span><span class="p">,</span> <span class="n">timeout</span><span class="p">,</span> <span class="n">func</span><span class="o">=</span><span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="p">):</span>
        <span class="k">while</span> <span class="n">predicate</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
                <span class="c1"># Sleep for the rest of the interval to ensure a ``TimeoutError`` is</span>
                <span class="c1"># raised, which is the expected behavior.</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">TimeoutError</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># pragma: no cover; we should never reach this point</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;timer never ticked&#39;</span><span class="p">)</span>


<div class="viewcode-block" id="ExecutionRequest"><a class="viewcode-back" href="../../../api-reference/service.html#runtime.service.executor.ExecutionRequest">[docs]</a><span class="k">class</span> <span class="nc">ExecutionRequest</span><span class="p">(</span><span class="n">NamedTuple</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A request for an :class:`Executor` to execute a callable.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        func: The callable. May or may be a coroutine function.</span>
<span class="sd">        args: Positonal arguments to pass to :attr:`func`.</span>
<span class="sd">        timeout: If the request is not periodic, the timeout is the maximum number of</span>
<span class="sd">            seconds the callable should run for. If the request is periodic, the timeout</span>
<span class="sd">            is the interval between invocations.</span>
<span class="sd">        periodic: Whether the callable should be invoked once or repeatedly at a fixed</span>
<span class="sd">            rate.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Generic named tuples are not yet supported, so we cannot yet specify ``func``&#39;s</span>
    <span class="c1"># return type as a type parameter.</span>
    <span class="c1"># https://github.com/python/mypy/issues/685</span>
    <span class="n">func</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Awaitable</span><span class="p">[</span><span class="kc">None</span><span class="p">]]]</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="kc">None</span>
    <span class="n">args</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">()</span>
    <span class="n">timeout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">periodic</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">loop</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">asyncio</span><span class="o">.</span><span class="n">AbstractEventLoop</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">future</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">asyncio</span><span class="o">.</span><span class="n">Future</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="ExecutionRequest.set_result"><a class="viewcode-back" href="../../../api-reference/service.html#runtime.service.executor.ExecutionRequest.set_result">[docs]</a>    <span class="k">def</span> <span class="nf">set_result</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="o">/</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Resolve this request&#39;s future.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">loop</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">future</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="ne">BaseException</span><span class="p">):</span>
                <span class="n">callback</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">future</span><span class="o">.</span><span class="n">set_exception</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">callback</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">future</span><span class="o">.</span><span class="n">set_result</span>
            <span class="n">_loop_call_soon</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loop</span><span class="p">,</span> <span class="n">callback</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span></div></div>


<span class="c1"># Sentinel values representing cancellation/stop requests.</span>
<span class="c1"># Must compare requests against these constants by *identity*, not value.</span>
<span class="n">CANCEL_REQUEST</span> <span class="o">=</span> <span class="n">ExecutionRequest</span><span class="p">()</span>
<span class="n">STOP_REQUEST</span> <span class="o">=</span> <span class="n">ExecutionRequest</span><span class="p">()</span>


<div class="viewcode-block" id="Executor"><a class="viewcode-back" href="../../../api-reference/service.html#runtime.service.executor.Executor">[docs]</a><span class="k">class</span> <span class="nc">Executor</span><span class="p">(</span><span class="n">abc</span><span class="o">.</span><span class="n">ABC</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Schedule and execute callables with timeouts.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="Executor.schedule"><a class="viewcode-back" href="../../../api-reference/service.html#runtime.service.executor.Executor.schedule">[docs]</a>    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">schedule</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">/</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="n">ExecutionRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Schedule a callable for execution.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            request: The execution request.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ExecutionError: If the callable was unable to be scheduled.</span>

<span class="sd">        Note:</span>
<span class="sd">            This method should be thread-safe but is allowed to block. The order in</span>
<span class="sd">            which callables are registered may or may not be meaningful. They may be</span>
<span class="sd">            executed in the order in which they were registered, or they may execute</span>
<span class="sd">            concurrently.</span>
<span class="sd">        &quot;&quot;&quot;</span></div>

<div class="viewcode-block" id="Executor.cancel"><a class="viewcode-back" href="../../../api-reference/service.html#runtime.service.executor.Executor.cancel">[docs]</a>    <span class="k">def</span> <span class="nf">cancel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">/</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Cancel all current execution.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="p">(</span><span class="n">CANCEL_REQUEST</span><span class="p">)</span></div>

<div class="viewcode-block" id="Executor.stop"><a class="viewcode-back" href="../../../api-reference/service.html#runtime.service.executor.Executor.stop">[docs]</a>    <span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">/</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Cancel all execution, then unblock :meth:`execute_forever`.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="p">(</span><span class="n">STOP_REQUEST</span><span class="p">)</span></div>

<div class="viewcode-block" id="Executor.execute_forever"><a class="viewcode-back" href="../../../api-reference/service.html#runtime.service.executor.Executor.execute_forever">[docs]</a>    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">execute_forever</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">/</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Execute callables indefinitely (blocking) until :meth:`stop` is called.&quot;&quot;&quot;</span></div></div>


<div class="viewcode-block" id="SyncExecutor"><a class="viewcode-back" href="../../../api-reference/service.html#runtime.service.executor.SyncExecutor">[docs]</a><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">SyncExecutor</span><span class="p">(</span><span class="n">Executor</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;An executor that executes synchronous functions, using alarms for timeouts.</span>

<span class="sd">    A synchronous executor may only run in the main thread because the main thread</span>
<span class="sd">    executes signal handlers. Synchronous handlers rely on the ``SIGALRM`` handler to</span>
<span class="sd">    raise an exception that will interrupt code that reaches a timeout.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        requests: A synchronous queue of execution requests.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">requests</span><span class="p">:</span> <span class="n">queue</span><span class="o">.</span><span class="n">Queue</span><span class="p">[</span><span class="n">ExecutionRequest</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span>
        <span class="n">default_factory</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="n">queue</span><span class="o">.</span><span class="n">Queue</span><span class="p">(</span><span class="mi">128</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="n">logger</span><span class="p">:</span> <span class="n">log</span><span class="o">.</span><span class="n">Logger</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="n">structlog</span><span class="o">.</span><span class="n">get_logger</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">schedule</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">/</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="n">ExecutionRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">requests</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

<div class="viewcode-block" id="SyncExecutor.execute"><a class="viewcode-back" href="../../../api-reference/service.html#runtime.service.executor.SyncExecutor.execute">[docs]</a>    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">/</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="n">ExecutionRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Execute a regular execution request.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            request: An execution request.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">periodic</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">run_once</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">func</span><span class="p">,</span> <span class="o">*</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">timeout</span><span class="p">)</span>
        <span class="n">run_periodically</span><span class="p">(</span>
            <span class="n">request</span><span class="o">.</span><span class="n">func</span><span class="p">,</span>
            <span class="o">*</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">,</span>
            <span class="n">timeout</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">timeout</span><span class="p">,</span>
            <span class="n">predicate</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">requests</span><span class="o">.</span><span class="n">empty</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span></div>

    <span class="k">def</span> <span class="nf">execute_forever</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">/</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">threading</span><span class="o">.</span><span class="n">current_thread</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">threading</span><span class="o">.</span><span class="n">main_thread</span><span class="p">():</span>
            <span class="k">raise</span> <span class="n">ExecutionError</span><span class="p">(</span>
                <span class="s1">&#39;sync executor must be used in the main thread&#39;</span><span class="p">,</span>
                <span class="n">main_thread</span><span class="o">=</span><span class="n">threading</span><span class="o">.</span><span class="n">main_thread</span><span class="p">()</span><span class="o">.</span><span class="n">ident</span><span class="p">,</span>
                <span class="n">current_thread</span><span class="o">=</span><span class="n">threading</span><span class="o">.</span><span class="n">current_thread</span><span class="p">()</span><span class="o">.</span><span class="n">ident</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Executor started&#39;</span><span class="p">,</span> <span class="n">thread_id</span><span class="o">=</span><span class="n">threading</span><span class="o">.</span><span class="n">current_thread</span><span class="p">()</span><span class="o">.</span><span class="n">ident</span><span class="p">)</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">request</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">request</span> <span class="ow">is</span> <span class="n">STOP_REQUEST</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Executor stopped&#39;</span><span class="p">)</span>
                <span class="k">break</span>
            <span class="k">if</span> <span class="n">request</span> <span class="ow">is</span> <span class="n">CANCEL_REQUEST</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Executor cancelled, idling&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s1">&#39;Executing function&#39;</span><span class="p">,</span>
                    <span class="n">func</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                    <span class="n">timeout</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">timeout</span><span class="p">,</span>
                    <span class="n">periodic</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">periodic</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">request</span><span class="o">.</span><span class="n">set_result</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">request</span><span class="p">))</span>
                <span class="k">except</span> <span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">ItimerError</span><span class="p">,</span> <span class="n">ExecutionError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">)</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Unable to execute function&#39;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="n">exc</span><span class="p">)</span>
                    <span class="n">request</span><span class="o">.</span><span class="n">set_result</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span></div>


<div class="viewcode-block" id="AsyncExecutor"><a class="viewcode-back" href="../../../api-reference/service.html#runtime.service.executor.AsyncExecutor">[docs]</a><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">AsyncExecutor</span><span class="p">(</span><span class="n">Executor</span><span class="p">,</span> <span class="n">api</span><span class="o">.</span><span class="n">Actions</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;An executor that executes coroutine functions.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        loop: The event loop running the coroutine functions as tasks.</span>
<span class="sd">        requests: An async queue of execution requests.</span>
<span class="sd">        max_actions: The maximum number of concurrently running tasks.</span>
<span class="sd">        requests_size: The size of the requests queue.</span>
<span class="sd">        running_actions: Maps coroutine functions to their running task instances. For</span>
<span class="sd">            resource contention reasons, only one task instance may exist at a time per</span>
<span class="sd">            coroutine function. Once a task completes, its entry is removed from this</span>
<span class="sd">            mapping.</span>
<span class="sd">        debug: ``asyncio`` debug flag.</span>
<span class="sd">        executor: ``asyncio`` executor for dispatching synchronous tasks.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">loop</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">asyncio</span><span class="o">.</span><span class="n">AbstractEventLoop</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">requests</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">asyncio</span><span class="o">.</span><span class="n">Queue</span><span class="p">[</span><span class="n">ExecutionRequest</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">max_actions</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">128</span>
    <span class="n">requests_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">128</span>
    <span class="n">running_actions</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">api</span><span class="o">.</span><span class="n">Action</span><span class="p">,</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Task</span><span class="p">[</span><span class="kc">None</span><span class="p">]]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span>
        <span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">configure_loop</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[],</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="kc">None</span>
    <span class="n">logger</span><span class="p">:</span> <span class="n">log</span><span class="o">.</span><span class="n">Logger</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="n">structlog</span><span class="o">.</span><span class="n">get_logger</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">schedule</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">/</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="n">ExecutionRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">loop</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">requests</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ExecutionError</span><span class="p">(</span><span class="s1">&#39;async executor is not ready&#39;</span><span class="p">)</span>
        <span class="n">_loop_call_soon</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loop</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">requests</span><span class="o">.</span><span class="n">put_nowait</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_cancel_actions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">/</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Cancel all running actions.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">running_actions</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
            <span class="n">task</span><span class="o">.</span><span class="n">cancel</span><span class="p">(</span><span class="s1">&#39;action cancelled&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_action_done</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">request</span><span class="p">:</span> <span class="n">ExecutionRequest</span><span class="p">,</span>
        <span class="n">action</span><span class="p">:</span> <span class="n">api</span><span class="o">.</span><span class="n">Action</span><span class="p">,</span>
        <span class="n">future</span><span class="p">:</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Future</span><span class="p">[</span><span class="kc">None</span><span class="p">],</span>
        <span class="o">/</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">running_actions</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">request</span><span class="o">.</span><span class="n">set_result</span><span class="p">(</span><span class="n">future</span><span class="o">.</span><span class="n">result</span><span class="p">())</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>  <span class="c1"># pylint: disable=broad-except; exception is re-raised</span>
            <span class="n">asyncio</span><span class="o">.</span><span class="n">get_running_loop</span><span class="p">()</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span>
                <span class="n">asyncio</span><span class="o">.</span><span class="n">to_thread</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">,</span>
                    <span class="s1">&#39;Action produced an error&#39;</span><span class="p">,</span>
                    <span class="n">exc_info</span><span class="o">=</span><span class="n">exc</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="n">request</span><span class="o">.</span><span class="n">set_result</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_register_action</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">/</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="n">ExecutionRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Schedule a regular request as an ``asyncio.Task`` instance.&quot;&quot;&quot;</span>
        <span class="n">action</span> <span class="o">=</span> <span class="n">typing</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">api</span><span class="o">.</span><span class="n">Action</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">func</span><span class="p">)</span>
        <span class="n">coro</span><span class="p">:</span> <span class="n">Awaitable</span><span class="p">[</span><span class="kc">None</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">periodic</span><span class="p">:</span>
            <span class="n">coro</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">wait_for</span><span class="p">(</span><span class="n">action</span><span class="p">(</span><span class="o">*</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">),</span> <span class="n">request</span><span class="o">.</span><span class="n">timeout</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">coro</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">spin</span><span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="o">*</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="n">interval</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">timeout</span><span class="p">)</span>
        <span class="n">task</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">coro</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;action&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">running_actions</span><span class="p">[</span><span class="n">action</span><span class="p">]</span> <span class="o">=</span> <span class="n">task</span>
        <span class="n">task</span><span class="o">.</span><span class="n">add_done_callback</span><span class="p">(</span><span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_action_done</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">action</span><span class="p">))</span>

<div class="viewcode-block" id="AsyncExecutor.dispatch"><a class="viewcode-back" href="../../../api-reference/service.html#runtime.service.executor.AsyncExecutor.dispatch">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">dispatch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">/</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">cooldown</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Receive and handle requests from the queue.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">configure_loop</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_running_loop</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">requests</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Queue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">requests_size</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">to_thread</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">,</span>
            <span class="s1">&#39;Executor started&#39;</span><span class="p">,</span>
            <span class="n">thread_id</span><span class="o">=</span><span class="n">threading</span><span class="o">.</span><span class="n">current_thread</span><span class="p">()</span><span class="o">.</span><span class="n">ident</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">request</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">request</span> <span class="ow">is</span> <span class="n">STOP_REQUEST</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_cancel_actions</span><span class="p">()</span>
                <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">to_thread</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">,</span> <span class="s1">&#39;Executor stopped&#39;</span><span class="p">)</span>
                <span class="k">break</span>
            <span class="k">if</span> <span class="n">request</span> <span class="ow">is</span> <span class="n">CANCEL_REQUEST</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_cancel_actions</span><span class="p">()</span>
                <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">to_thread</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">,</span> <span class="s1">&#39;Executor cancelled, idling&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">request</span><span class="o">.</span><span class="n">func</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">running_actions</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">to_thread</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">,</span> <span class="s1">&#39;Action already running&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">running_actions</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_actions</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">to_thread</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">,</span>
                    <span class="s1">&#39;Max number of actions running&#39;</span><span class="p">,</span>
                    <span class="n">max_actions</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_actions</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">cooldown</span><span class="p">)</span>
                <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">suppress</span><span class="p">(</span><span class="n">asyncio</span><span class="o">.</span><span class="n">QueueFull</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">requests</span><span class="o">.</span><span class="n">put_nowait</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_register_action</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
                <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">to_thread</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">,</span> <span class="s1">&#39;Registered action&#39;</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">execute_forever</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">/</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dispatch</span><span class="p">())</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">safe</span>
    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">action</span><span class="p">:</span> <span class="n">api</span><span class="o">.</span><span class="n">Action</span><span class="p">,</span>
        <span class="o">/</span><span class="p">,</span>
        <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
        <span class="n">timeout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">30</span><span class="p">,</span>
        <span class="n">periodic</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">schedule</span><span class="p">(</span><span class="n">ExecutionRequest</span><span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">timeout</span><span class="p">,</span> <span class="n">periodic</span><span class="p">))</span>

    <span class="nd">@api</span><span class="o">.</span><span class="n">safe</span>
    <span class="k">def</span> <span class="nf">is_running</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">action</span><span class="p">:</span> <span class="n">api</span><span class="o">.</span><span class="n">Action</span><span class="p">,</span> <span class="o">/</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">action</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">running_actions</span></div>


<div class="viewcode-block" id="Dispatcher"><a class="viewcode-back" href="../../../api-reference/service.html#runtime.service.executor.Dispatcher">[docs]</a><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">Dispatcher</span><span class="p">(</span><span class="n">remote</span><span class="o">.</span><span class="n">Handler</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;An RPC handler to forward execution requests to the executors.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        timeouts: Maps function name patterns to a timeout duration (in seconds).</span>
<span class="sd">        student_code: Student code module.</span>
<span class="sd">        sync_exec: An synchronous executor for executing the ``*_setup`` and ``*_main``</span>
<span class="sd">            functions.</span>
<span class="sd">        async_exec: An asynchronous executor for executing actions.</span>
<span class="sd">        buffers: Buffer manager.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">buffers</span><span class="p">:</span> <span class="n">BufferStore</span>
    <span class="n">student_code_name</span><span class="p">:</span> <span class="n">InitVar</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;studentcode&#39;</span>
    <span class="n">timeouts</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="n">Pattern</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
    <span class="n">names</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
    <span class="n">student_code</span><span class="p">:</span> <span class="n">types</span><span class="o">.</span><span class="n">ModuleType</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">sync_exec</span><span class="p">:</span> <span class="n">SyncExecutor</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="n">SyncExecutor</span><span class="p">)</span>
    <span class="n">async_exec</span><span class="p">:</span> <span class="n">AsyncExecutor</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="n">AsyncExecutor</span><span class="p">)</span>
    <span class="n">client</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">remote</span><span class="o">.</span><span class="n">Client</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">logger</span><span class="p">:</span> <span class="n">log</span><span class="o">.</span><span class="n">AsyncLogger</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="n">log</span><span class="o">.</span><span class="n">get_logger</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">/</span><span class="p">,</span> <span class="n">student_code_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">student_code</span> <span class="o">=</span> <span class="n">types</span><span class="o">.</span><span class="n">ModuleType</span><span class="p">(</span><span class="n">student_code_name</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_should_import</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">/</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Whether student code should be imported for the first time.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">student_code</span><span class="p">,</span> <span class="s1">&#39;__file__&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_print</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="o">/</span><span class="p">,</span>
        <span class="o">*</span><span class="n">values</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
        <span class="n">sep</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">sync_bl</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">sep</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">values</span><span class="p">)),</span> <span class="n">student_print</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<div class="viewcode-block" id="Dispatcher.reload"><a class="viewcode-back" href="../../../api-reference/service.html#runtime.service.executor.Dispatcher.reload">[docs]</a>    <span class="k">def</span> <span class="nf">reload</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">/</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">enable_gamepads</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Load student code from disk and monkey-patch in the Runtime API.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            enable_gamepads: Whether to allow reading from gamepads.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_should_import</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">student_code</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">student_code</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">student_code</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">reload</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">student_code</span><span class="p">)</span>
        <span class="n">student_code</span> <span class="o">=</span> <span class="n">typing</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">api</span><span class="o">.</span><span class="n">StudentCodeModule</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">student_code</span><span class="p">)</span>
        <span class="n">student_code</span><span class="o">.</span><span class="n">Alliance</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">Alliance</span>
        <span class="n">student_code</span><span class="o">.</span><span class="n">Actions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">async_exec</span>
        <span class="n">student_code</span><span class="o">.</span><span class="n">Robot</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">Robot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buffers</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">sync_bl</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">names</span><span class="p">)</span>
        <span class="n">student_code</span><span class="o">.</span><span class="n">Gamepad</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">Gamepad</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">buffers</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">sync_bl</span><span class="p">,</span>
            <span class="n">enabled</span><span class="o">=</span><span class="n">enable_gamepads</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">student_code</span><span class="o">.</span><span class="n">Field</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">Field</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buffers</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">sync_bl</span><span class="p">)</span>
        <span class="n">student_code</span><span class="o">.</span><span class="n">print</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_print</span>  <span class="c1"># type: ignore[attr-defined]</span>
        <span class="n">module_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">student_code</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">sync_bl</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Student code reloaded&#39;</span><span class="p">,</span> <span class="n">student_code</span><span class="o">=</span><span class="n">module_name</span><span class="p">)</span></div>

<div class="viewcode-block" id="Dispatcher.prepare_student_code_run"><a class="viewcode-back" href="../../../api-reference/service.html#runtime.service.executor.Dispatcher.prepare_student_code_run">[docs]</a>    <span class="k">def</span> <span class="nf">prepare_student_code_run</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="o">/</span><span class="p">,</span>
        <span class="n">requests</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="n">enable_gamepads</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Prepare to run student code.</span>

<span class="sd">        Reload the student code module, then enqueue execution requests for the module&#39;s</span>
<span class="sd">        functions.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            requests: A list of keyword arguments to :class:`ExecutionRequest`. However,</span>
<span class="sd">                the ``func`` argument should be a string naming a function in the</span>
<span class="sd">                student code module. Also, if ``timeout`` is not present, this method</span>
<span class="sd">                matches each function name against patterns in :attr:`timeouts` to find</span>
<span class="sd">                the timeout.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reload</span><span class="p">(</span><span class="n">enable_gamepads</span><span class="o">=</span><span class="n">enable_gamepads</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">request</span> <span class="ow">in</span> <span class="n">requests</span><span class="p">:</span>
            <span class="n">func_name</span> <span class="o">=</span> <span class="n">request</span><span class="p">[</span><span class="s1">&#39;func&#39;</span><span class="p">]</span>
            <span class="n">request</span><span class="p">[</span><span class="s1">&#39;func&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">func</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">student_code</span><span class="p">,</span> <span class="n">func_name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">callable</span><span class="p">(</span><span class="n">func</span><span class="p">)</span> <span class="ow">or</span> <span class="n">inspect</span><span class="o">.</span><span class="n">iscoroutinefunction</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">sync_bl</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="s1">&#39;Must provide a regular function&#39;</span><span class="p">,</span>
                    <span class="n">func</span><span class="o">=</span><span class="n">func_name</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="s1">&#39;timeout&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">request</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">pattern</span><span class="p">,</span> <span class="n">timeout</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeouts</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">pattern</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">func_name</span><span class="p">):</span>
                        <span class="n">request</span><span class="p">[</span><span class="s1">&#39;timeout&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">timeout</span>
                        <span class="k">break</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sync_exec</span><span class="o">.</span><span class="n">schedule</span><span class="p">(</span><span class="n">ExecutionRequest</span><span class="p">(</span><span class="o">**</span><span class="n">request</span><span class="p">))</span></div>

<div class="viewcode-block" id="Dispatcher.execute"><a class="viewcode-back" href="../../../api-reference/service.html#runtime.service.executor.Dispatcher.execute">[docs]</a>    <span class="nd">@remote</span><span class="o">.</span><span class="n">route</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="o">/</span><span class="p">,</span>
        <span class="n">requests</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="n">block</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">enable_gamepads</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Request student code execution.&quot;&quot;&quot;</span>
        <span class="n">futures</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">request</span> <span class="ow">in</span> <span class="n">requests</span><span class="p">:</span>
            <span class="n">request</span><span class="p">[</span><span class="s1">&#39;loop&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_running_loop</span><span class="p">()</span>
            <span class="n">request</span><span class="p">[</span><span class="s1">&#39;future&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">future</span> <span class="o">=</span> <span class="n">loop</span><span class="o">.</span><span class="n">create_future</span><span class="p">()</span>
            <span class="n">futures</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">future</span><span class="p">)</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="n">requests</span><span class="p">,</span> <span class="n">enable_gamepads</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">to_thread</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sync_exec</span><span class="o">.</span><span class="n">schedule</span><span class="p">,</span>
            <span class="n">ExecutionRequest</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prepare_student_code_run</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="o">*</span><span class="n">futures</span><span class="p">))</span> <span class="k">if</span> <span class="n">block</span> <span class="k">else</span> <span class="p">[]</span></div>

<div class="viewcode-block" id="Dispatcher.idle"><a class="viewcode-back" href="../../../api-reference/service.html#runtime.service.executor.Dispatcher.idle">[docs]</a>    <span class="nd">@remote</span><span class="o">.</span><span class="n">route</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">idle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">/</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Suspend all execution (synchronous and asynchronous).&quot;&quot;&quot;</span>
        <span class="n">suppress</span> <span class="o">=</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">suppress</span><span class="p">(</span><span class="n">ExecutionError</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">suppress</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">to_thread</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sync_exec</span><span class="o">.</span><span class="n">cancel</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">suppress</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">to_thread</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">async_exec</span><span class="o">.</span><span class="n">cancel</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">call</span><span class="o">.</span><span class="n">disable</span><span class="p">(</span><span class="n">address</span><span class="o">=</span><span class="sa">b</span><span class="s1">&#39;device-service&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Dispatcher.auto"><a class="viewcode-back" href="../../../api-reference/service.html#runtime.service.executor.Dispatcher.auto">[docs]</a>    <span class="nd">@remote</span><span class="o">.</span><span class="n">route</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">auto</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">/</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Enter autonomous mode.&quot;&quot;&quot;</span>
        <span class="n">requests</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span><span class="s1">&#39;func&#39;</span><span class="p">:</span> <span class="s1">&#39;autonomous_setup&#39;</span><span class="p">},</span>
            <span class="p">{</span><span class="s1">&#39;func&#39;</span><span class="p">:</span> <span class="s1">&#39;autonomous_main&#39;</span><span class="p">,</span> <span class="s1">&#39;periodic&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span>
        <span class="p">]</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">requests</span><span class="p">,</span> <span class="n">enable_gamepads</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>

<div class="viewcode-block" id="Dispatcher.teleop"><a class="viewcode-back" href="../../../api-reference/service.html#runtime.service.executor.Dispatcher.teleop">[docs]</a>    <span class="nd">@remote</span><span class="o">.</span><span class="n">route</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">teleop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">/</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Enter teleop mode.&quot;&quot;&quot;</span>
        <span class="n">requests</span> <span class="o">=</span> <span class="p">[{</span><span class="s1">&#39;func&#39;</span><span class="p">:</span> <span class="s1">&#39;teleop_setup&#39;</span><span class="p">},</span> <span class="p">{</span><span class="s1">&#39;func&#39;</span><span class="p">:</span> <span class="s1">&#39;teleop_main&#39;</span><span class="p">,</span> <span class="s1">&#39;periodic&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}]</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">requests</span><span class="p">)</span></div>

<div class="viewcode-block" id="Dispatcher.estop"><a class="viewcode-back" href="../../../api-reference/service.html#runtime.service.executor.Dispatcher.estop">[docs]</a>    <span class="nd">@remote</span><span class="o">.</span><span class="n">route</span>
    <span class="k">def</span> <span class="nf">estop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">/</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Raise an emergency stop exception.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sync_exec</span><span class="o">.</span><span class="n">schedule</span><span class="p">(</span><span class="n">ExecutionRequest</span><span class="p">(</span><span class="n">_estop</span><span class="p">))</span></div></div>


<span class="k">async</span> <span class="k">def</span> <span class="nf">_poll_done</span><span class="p">(</span><span class="n">done</span><span class="p">:</span> <span class="n">threading</span><span class="o">.</span><span class="n">Event</span><span class="p">,</span> <span class="n">task</span><span class="p">:</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Task</span><span class="p">[</span><span class="kc">None</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">done</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
        <span class="n">task</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">_join</span><span class="p">(</span><span class="n">thread</span><span class="p">:</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">thread</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">thread</span><span class="o">.</span><span class="n">is_alive</span><span class="p">():</span>  <span class="c1"># pragma: no cover</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;thread </span><span class="si">{</span><span class="n">thread</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1"> (id=</span><span class="si">{</span><span class="n">thread</span><span class="o">.</span><span class="n">ident</span><span class="si">}</span><span class="s1">) did not join&#39;</span><span class="p">)</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">(</span>
    <span class="n">dispatcher</span><span class="p">:</span> <span class="n">Dispatcher</span><span class="p">,</span>
    <span class="n">ready</span><span class="p">:</span> <span class="n">threading</span><span class="o">.</span><span class="n">Event</span><span class="p">,</span>
    <span class="n">done</span><span class="p">:</span> <span class="n">threading</span><span class="o">.</span><span class="n">Event</span><span class="p">,</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="o">**</span><span class="n">options</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Service thread&#39;s async entry point.&quot;&quot;&quot;</span>
    <span class="k">async</span> <span class="k">with</span> <span class="n">process</span><span class="o">.</span><span class="n">Application</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span> <span class="k">as</span> <span class="n">app</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">app</span><span class="o">.</span><span class="n">make_log_publisher</span><span class="p">()</span>
        <span class="n">app</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">callback</span><span class="p">(</span><span class="n">dispatcher</span><span class="o">.</span><span class="n">sync_exec</span><span class="o">.</span><span class="n">stop</span><span class="p">)</span>
        <span class="n">app</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">callback</span><span class="p">(</span><span class="n">dispatcher</span><span class="o">.</span><span class="n">async_exec</span><span class="o">.</span><span class="n">stop</span><span class="p">)</span>
        <span class="n">dispatcher</span><span class="o">.</span><span class="n">client</span> <span class="o">=</span> <span class="k">await</span> <span class="n">app</span><span class="o">.</span><span class="n">make_client</span><span class="p">()</span>
        <span class="n">dispatcher</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">bind</span><span class="p">()</span>
        <span class="n">dispatcher</span><span class="o">.</span><span class="n">sync_exec</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">dispatcher</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">sync_bl</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;sync&#39;</span><span class="p">)</span>
        <span class="n">dispatcher</span><span class="o">.</span><span class="n">async_exec</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">dispatcher</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">sync_bl</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;async&#39;</span><span class="p">)</span>
        <span class="n">dispatcher</span><span class="o">.</span><span class="n">async_exec</span><span class="o">.</span><span class="n">configure_loop</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">configure_loop</span>
        <span class="k">await</span> <span class="n">app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Execution dispatcher started&#39;</span><span class="p">)</span>
        <span class="c1"># Logger has been attached to this thread&#39;s event loop.</span>
        <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">to_thread</span><span class="p">(</span><span class="n">ready</span><span class="o">.</span><span class="n">set</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">app</span><span class="o">.</span><span class="n">make_service</span><span class="p">(</span><span class="n">dispatcher</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span>
            <span class="n">process</span><span class="o">.</span><span class="n">spin</span><span class="p">(</span><span class="n">_poll_done</span><span class="p">,</span> <span class="n">done</span><span class="p">,</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">current_task</span><span class="p">(),</span> <span class="n">interval</span><span class="o">=</span><span class="mf">0.1</span><span class="p">),</span>
            <span class="n">app</span><span class="o">.</span><span class="n">report_health</span><span class="p">(),</span>
        <span class="p">)</span>


<div class="viewcode-block" id="target"><a class="viewcode-back" href="../../../api-reference/service.html#runtime.service.executor.target">[docs]</a><span class="k">def</span> <span class="nf">target</span><span class="p">(</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;The process entry point.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        name: This process&#39;s application name.</span>
<span class="sd">        options: Processed command-line options.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">uvloop</span><span class="o">.</span><span class="n">install</span><span class="p">()</span>
    <span class="n">catalog</span> <span class="o">=</span> <span class="n">BufferStore</span><span class="o">.</span><span class="n">make_catalog</span><span class="p">(</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;dev_catalog&#39;</span><span class="p">])</span>
    <span class="k">with</span> <span class="n">BufferStore</span><span class="p">(</span><span class="n">catalog</span><span class="p">)</span> <span class="k">as</span> <span class="n">buffers</span><span class="p">:</span>
        <span class="n">dispatcher</span> <span class="o">=</span> <span class="n">Dispatcher</span><span class="p">(</span>
            <span class="n">buffers</span><span class="p">,</span>
            <span class="n">options</span><span class="p">[</span><span class="s1">&#39;exec_module&#39;</span><span class="p">],</span>
            <span class="nb">dict</span><span class="p">(</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;exec_timeout&#39;</span><span class="p">]),</span>
            <span class="nb">dict</span><span class="p">(</span><span class="n">options</span><span class="p">[</span><span class="s1">&#39;dev_name&#39;</span><span class="p">]),</span>
        <span class="p">)</span>
        <span class="n">ready</span><span class="p">,</span> <span class="n">done</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Event</span><span class="p">(),</span> <span class="n">threading</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">signum</span> <span class="ow">in</span> <span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGINT</span><span class="p">,</span> <span class="n">signal</span><span class="o">.</span><span class="n">SIGTERM</span><span class="p">):</span>
            <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signum</span><span class="p">,</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">_handle_termination</span><span class="p">,</span> <span class="n">done</span><span class="p">))</span>
        <span class="n">service_thread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span>
            <span class="n">target</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">(</span><span class="n">dispatcher</span><span class="p">,</span> <span class="n">ready</span><span class="p">,</span> <span class="n">done</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">)),</span>
            <span class="n">daemon</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;service&#39;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">service_thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="n">ready</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
        <span class="n">async_exec_thread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span>
            <span class="n">target</span><span class="o">=</span><span class="n">dispatcher</span><span class="o">.</span><span class="n">async_exec</span><span class="o">.</span><span class="n">execute_forever</span><span class="p">,</span>
            <span class="n">daemon</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;async-exec&#39;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">async_exec_thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="n">dispatcher</span><span class="o">.</span><span class="n">sync_exec</span><span class="o">.</span><span class="n">execute_forever</span><span class="p">()</span>
        <span class="n">_join</span><span class="p">(</span><span class="n">service_thread</span><span class="p">)</span>
        <span class="n">_join</span><span class="p">(</span><span class="n">async_exec_thread</span><span class="p">)</span></div>
</pre></div>

          </div>
          <div class="page-nav">
            <div class="inner"><ul class="page-nav">
</ul><div class="footer" role="contentinfo">
      &#169; Copyright 2021, Pioneers in Engineering.
    <br>
    Created using <a href="http://sphinx-doc.org/">Sphinx</a> 4.2.0 with <a href="https://github.com/schettino72/sphinx_press_theme">Press Theme</a> 0.8.0.
</div>
            </div>
          </div>
      </page>
    </div></div>
    
    
  </body>
</html>