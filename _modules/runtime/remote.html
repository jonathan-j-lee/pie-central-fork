<!DOCTYPE html>
<html >
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
      <title>runtime.remote</title>
    
          <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
          <link rel="stylesheet" href="../../_static/theme.css " type="text/css" />
          <link rel="stylesheet" href="../../_static/css/custom.css" type="text/css" />
      
      <!-- sphinx script_files -->
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>

      
      <!-- bundled in js (rollup iife) -->
      <!-- <script src="../../_static/theme-vendors.js"></script> -->
      <script src="../../_static/theme.js" defer></script>
    
  <link rel="index" title="Index" href="../../genindex.html" />
  <link rel="search" title="Search" href="../../search.html" /> 
  </head>

  <body>
    <div id="app">
    <div class="theme-container" :class="pageClasses"><navbar @toggle-sidebar="toggleSidebar">
  <router-link to="../../index.html" class="home-link">
    
      <span class="site-name">Runtime</span>
    
  </router-link>

  <div class="links">
    <navlinks class="can-hide">



    </navlinks>
  </div>
</navbar>

      
      <div class="sidebar-mask" @click="toggleSidebar(false)">
      </div>
        <sidebar @toggle-sidebar="toggleSidebar">
          
          <navlinks>
            



            
          </navlinks><div id="searchbox" class="searchbox" role="search">
  <div class="caption"><span class="caption-text">Quick search</span>
    <div class="searchformwrapper">
      <form class="search" action="../../search.html" method="get">
        <input type="text" name="q" />
        <input type="submit" value="Search" />
        <input type="hidden" name="check_keywords" value="yes" />
        <input type="hidden" name="area" value="default" />
      </form>
    </div>
  </div>
</div><div class="sidebar-links" role="navigation" aria-label="main navigation">
  
    <div class="sidebar-group">
      <p class="caption">
        <span class="caption-text"><a href="../../index.html#runtime-documentation">Contents:</a></span>
      </p>
      <ul class="">
        
          <li class="toctree-l1 ">
            
              <a href="../../design.html" class="reference internal ">Design Goals</a>
            

            
          </li>

        
          <li class="toctree-l1 ">
            
              <a href="../../architecture.html" class="reference internal ">Architecture</a>
            

            
          </li>

        
          <li class="toctree-l1 ">
            
              <a href="../../ipc.html" class="reference internal ">IPC</a>
            

            
          </li>

        
          <li class="toctree-l1 ">
            
              <a href="../../smart-devices.html" class="reference internal ">Smart Devices</a>
            

            
          </li>

        
          <li class="toctree-l1 ">
            
              <a href="../../api-reference/index.html" class="reference internal ">API Reference</a>
            

            
          </li>

        
      </ul>
    </div>
  
</div>
        </sidebar>

      <page>
          <div class="body-header" role="navigation" aria-label="navigation">
  
  <ul class="breadcrumbs">
    <li><a href="../../index.html">Docs</a> &raquo;</li>
    
      <li><a href="../index.html">Module code</a> &raquo;</li>
    
    <li>runtime.remote</li>
  </ul>
  

  <ul class="page-nav">
</ul>
  
</div>
<hr>
          <div class="content" role="main" v-pre>
            
  <h1>Source code for runtime.remote</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Remote (procedure) calls.</span>

<span class="sd">Much like :mod:`asyncio`&#39;s transports and protocols, this module is divided into</span>
<span class="sd">low-level and high-level APIs:</span>

<span class="sd">* The low-level API, :class:`Node` and its implementations, deal with transporting</span>
<span class="sd">  discrete binary messages and managing the underlying transport.</span>
<span class="sd">* The high-level API, :class:`Endpoint` and its implementations, implement</span>
<span class="sd">  request/response semantics. Most consumers should use the high-level API.</span>

<span class="sd">This remote call message format is based on `MessagePack-RPC`_, except this module uses</span>
<span class="sd">:mod:`cbor2` for serialization.</span>

<span class="sd">Every application (process) typically creates a single :class:`Handler` bound to one or</span>
<span class="sd">more :class:`Service` instances. The handler encapsulates the application&#39;s business</span>
<span class="sd">logic and state, while each service exposes the handler&#39;s methods to a different</span>
<span class="sd">transport.</span>

<span class="sd">.. _MessagePack-RPC:</span>
<span class="sd">    https://github.com/msgpack-rpc/msgpack-rpc/blob/master/spec.md</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">abc</span>
<span class="kn">import</span> <span class="nn">asyncio</span>
<span class="kn">import</span> <span class="nn">contextlib</span>
<span class="kn">import</span> <span class="nn">enum</span>
<span class="kn">import</span> <span class="nn">functools</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">import</span> <span class="nn">types</span>
<span class="kn">import</span> <span class="nn">typing</span>
<span class="kn">from</span> <span class="nn">collections.abc</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">AsyncIterator</span><span class="p">,</span>
    <span class="n">Awaitable</span><span class="p">,</span>
    <span class="n">Callable</span><span class="p">,</span>
    <span class="n">Collection</span><span class="p">,</span>
    <span class="n">Iterator</span><span class="p">,</span>
    <span class="n">MutableMapping</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">field</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Generic</span><span class="p">,</span> <span class="n">NoReturn</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Protocol</span><span class="p">,</span> <span class="n">TypeVar</span><span class="p">,</span> <span class="n">Union</span>
<span class="kn">from</span> <span class="nn">urllib.parse</span> <span class="kn">import</span> <span class="n">urlsplit</span>

<span class="kn">import</span> <span class="nn">cbor2</span>
<span class="kn">import</span> <span class="nn">structlog</span>
<span class="kn">import</span> <span class="nn">zmq</span>
<span class="kn">import</span> <span class="nn">zmq.asyncio</span>
<span class="kn">import</span> <span class="nn">zmq.error</span>

<span class="kn">from</span> <span class="nn">.exception</span> <span class="kn">import</span> <span class="n">RuntimeBaseException</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;Client&#39;</span><span class="p">,</span>
    <span class="s1">&#39;DatagramNode&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Endpoint&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Handler&#39;</span><span class="p">,</span>
    <span class="s1">&#39;MessageType&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Node&#39;</span><span class="p">,</span>
    <span class="s1">&#39;RemoteCallError&#39;</span><span class="p">,</span>
    <span class="s1">&#39;RequestTracker&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Router&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Service&#39;</span><span class="p">,</span>
    <span class="s1">&#39;SocketNode&#39;</span><span class="p">,</span>
    <span class="s1">&#39;route&#39;</span><span class="p">,</span>
<span class="p">]</span>


<div class="viewcode-block" id="RemoteCallError"><a class="viewcode-back" href="../../api-reference/remote.html#runtime.log.RemoteCallError">[docs]</a><span class="k">class</span> <span class="nc">RemoteCallError</span><span class="p">(</span><span class="n">RuntimeBaseException</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Error produced by executing a remote call.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        message: A human-readable description of the exception.</span>
<span class="sd">        context: Machine-readable data.</span>
<span class="sd">    &quot;&quot;&quot;</span></div>


<div class="viewcode-block" id="MessageType"><a class="viewcode-back" href="../../api-reference/remote.html#runtime.log.MessageType">[docs]</a><span class="k">class</span> <span class="nc">MessageType</span><span class="p">(</span><span class="n">enum</span><span class="o">.</span><span class="n">IntEnum</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The message type ID.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        REQUEST: Denotes a request message sent by clients. Requires a response.</span>
<span class="sd">        RESPONSE: Denotes a response message sent by services.</span>
<span class="sd">        NOTIFICATION: Denotes a notification message sent by clients. Does not require a</span>
<span class="sd">            response. Unlike the synchronous request-response pattern, notifications may</span>
<span class="sd">            be pipelined (*i.e.*, multiple notifications in-flight simultaneously) for</span>
<span class="sd">            increased throughput.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">REQUEST</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">RESPONSE</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">NOTIFICATION</span> <span class="o">=</span> <span class="mi">2</span></div>


<span class="n">Segments</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">bytes</span><span class="p">],</span> <span class="n">Any</span><span class="p">]</span>
<span class="n">NodeType</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s1">&#39;NodeType&#39;</span><span class="p">,</span> <span class="n">bound</span><span class="o">=</span><span class="s1">&#39;Node&#39;</span><span class="p">)</span>
<span class="n">EndpointType</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s1">&#39;EndpointType&#39;</span><span class="p">,</span> <span class="n">bound</span><span class="o">=</span><span class="s1">&#39;Endpoint&#39;</span><span class="p">)</span>
<span class="n">SocketOptions</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">]]</span>


<div class="viewcode-block" id="get_logger"><a class="viewcode-back" href="../../api-reference/log.html#runtime.log.get_logger">[docs]</a><span class="k">def</span> <span class="nf">get_logger</span><span class="p">(</span><span class="o">*</span><span class="n">factory_args</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="o">**</span><span class="n">context</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">structlog</span><span class="o">.</span><span class="n">stdlib</span><span class="o">.</span><span class="n">AsyncBoundLogger</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Get an unbound async-compatible logger.&quot;&quot;&quot;</span>
    <span class="n">logger</span> <span class="o">=</span> <span class="n">structlog</span><span class="o">.</span><span class="n">get_logger</span><span class="p">(</span>
        <span class="o">*</span><span class="n">factory_args</span><span class="p">,</span>
        <span class="o">**</span><span class="n">context</span><span class="p">,</span>
        <span class="n">wrapper_class</span><span class="o">=</span><span class="n">structlog</span><span class="o">.</span><span class="n">stdlib</span><span class="o">.</span><span class="n">AsyncBoundLogger</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">typing</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">structlog</span><span class="o">.</span><span class="n">stdlib</span><span class="o">.</span><span class="n">AsyncBoundLogger</span><span class="p">,</span> <span class="n">logger</span><span class="p">)</span></div>


<div class="viewcode-block" id="Node"><a class="viewcode-back" href="../../api-reference/remote.html#runtime.log.Node">[docs]</a><span class="nd">@dataclass</span>  <span class="c1"># type: ignore[misc]</span>
<span class="k">class</span> <span class="nc">Node</span><span class="p">(</span><span class="n">abc</span><span class="o">.</span><span class="n">ABC</span><span class="p">):</span>  <span class="c1"># https://github.com/python/mypy/issues/5374</span>
    <span class="sd">&quot;&quot;&quot;A transceiver of discrete binary messages.</span>

<span class="sd">    A node wraps an underlying transport, such as a UDP endpoint, that it can repeatedly</span>
<span class="sd">    open, close, and reopen. :class:`Node` supports the async context manager protocol</span>
<span class="sd">    (reusable) for automatically managing the transport.</span>

<span class="sd">    When the transport is open, a node can send to and receive messages from one or more</span>
<span class="sd">    peers concurrently.</span>

<span class="sd">    State Diagram::</span>

<span class="sd">        start [-&gt; closed]? -&gt; open</span>
<span class="sd">            [[-&gt; close -&gt; open]? [-&gt; send]? [-&gt; recv]? [-&gt; closed?]]*</span>
<span class="sd">        -&gt; close -&gt; end</span>

<span class="sd">    The data segments and address a :class:`Node` sends and receives are opaque to the</span>
<span class="sd">    node. Their format and semantics depend on the transport and :class:`Endpoint` the</span>
<span class="sd">    node works with.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        send_count: The number of messages sent since the transport was opened.</span>
<span class="sd">        recv_count: The number of messages received since the transport was opened.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">recv_queue</span><span class="p">:</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Queue</span><span class="p">[</span><span class="n">Segments</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span>
        <span class="n">default_factory</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Queue</span><span class="p">(</span><span class="mi">128</span><span class="p">),</span>
        <span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="nb">repr</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">send_count</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="nb">repr</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">recv_count</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="nb">repr</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="fm">__aenter__</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">NodeType</span><span class="p">,</span> <span class="o">/</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NodeType</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">closed</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">open</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">send_count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">recv_count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">async</span> <span class="k">def</span> <span class="fm">__aexit__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">_exc_type</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">type</span><span class="p">[</span><span class="ne">BaseException</span><span class="p">]],</span>
        <span class="n">_exc</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="ne">BaseException</span><span class="p">],</span>
        <span class="n">_traceback</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">types</span><span class="o">.</span><span class="n">TracebackType</span><span class="p">],</span>
        <span class="o">/</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">closed</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<div class="viewcode-block" id="Node.send"><a class="viewcode-back" href="../../api-reference/remote.html#runtime.log.Node.send">[docs]</a>    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">send</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">parts</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">bytes</span><span class="p">],</span>
        <span class="o">/</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">address</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Send a message.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            parts: Zero or more data segments.</span>
<span class="sd">            address: The destination&#39;s address.</span>

<span class="sd">        Raises:</span>
<span class="sd">            RemoteCallError: If the transport cannot send the message. May reopen the</span>
<span class="sd">                internal transport.</span>
<span class="sd">        &quot;&quot;&quot;</span></div>

<div class="viewcode-block" id="Node.recv"><a class="viewcode-back" href="../../api-reference/remote.html#runtime.log.Node.recv">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">recv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">/</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Segments</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Receive a message.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Zero or more data segments and an address, which are transport-dependent.</span>

<span class="sd">        Raises:</span>
<span class="sd">            RemoteCallError: If the transport cannot receive a message.</span>

<span class="sd">        Note:</span>
<span class="sd">            Asking the transport directly for messages may be problematic if it is</span>
<span class="sd">            reopened or does not support concurrent waiters.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">can_recv</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">RemoteCallError</span><span class="p">(</span><span class="s1">&#39;transport does not support recv&#39;</span><span class="p">)</span>
        <span class="n">item</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">recv_queue</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">recv_count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">item</span></div>

<div class="viewcode-block" id="Node.open"><a class="viewcode-back" href="../../api-reference/remote.html#runtime.log.Node.open">[docs]</a>    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">open</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">/</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Open the internal transport.&quot;&quot;&quot;</span></div>

<div class="viewcode-block" id="Node.close"><a class="viewcode-back" href="../../api-reference/remote.html#runtime.log.Node.close">[docs]</a>    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">/</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Close the internal transport.&quot;&quot;&quot;</span></div>

    <span class="nd">@property</span>
    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">closed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">/</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Whether the internal transport is closed.&quot;&quot;&quot;</span>

    <span class="nd">@property</span>
    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">can_recv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">/</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Whether the transport can receive messages.&quot;&quot;&quot;</span>

    <span class="nd">@contextlib</span><span class="o">.</span><span class="n">asynccontextmanager</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">_maybe_reopen</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="o">/</span><span class="p">,</span>
        <span class="o">*</span><span class="n">exc_types</span><span class="p">:</span> <span class="nb">type</span><span class="p">[</span><span class="ne">Exception</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AsyncIterator</span><span class="p">[</span><span class="kc">None</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;An async context manager for reopening the transport when an error occurs.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            exc_types: Exception types to catch. If none are given, defaults to</span>
<span class="sd">                :class:`Exception`.</span>

<span class="sd">        Raises:</span>
<span class="sd">            RemoteCallError: If the transport is reopened.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">closed</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">RemoteCallError</span><span class="p">(</span><span class="s1">&#39;transport is closed&#39;</span><span class="p">)</span>
        <span class="n">exc_types</span> <span class="o">=</span> <span class="n">exc_types</span> <span class="ow">or</span> <span class="p">(</span><span class="ne">Exception</span><span class="p">,)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">yield</span>
        <span class="k">except</span> <span class="n">exc_types</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">open</span><span class="p">()</span>
            <span class="k">raise</span> <span class="n">RemoteCallError</span><span class="p">(</span><span class="s1">&#39;node transport reopened&#39;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">exc</span></div>


<span class="n">SocketOptionType</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">]]</span>


<div class="viewcode-block" id="DatagramNode"><a class="viewcode-back" href="../../api-reference/remote.html#runtime.log.DatagramNode">[docs]</a><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">DatagramNode</span><span class="p">(</span><span class="n">Node</span><span class="p">,</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">DatagramProtocol</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A wrapper around :mod:`asyncio`&#39;s datagram support.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        host: Hostname.</span>
<span class="sd">        port: Port number.</span>
<span class="sd">        bind: Whether to bind the socket to a local address or connect to a remote one.</span>
<span class="sd">        options: Socket options in the form `(level, option, value)` passed to</span>
<span class="sd">            :meth:`socket.socket.setsockopt`.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">host</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="n">port</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8000</span>
    <span class="n">bind</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">options</span><span class="p">:</span> <span class="n">Collection</span><span class="p">[</span><span class="n">SocketOptionType</span><span class="p">]</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">()</span>
    <span class="n">transport</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">asyncio</span><span class="o">.</span><span class="n">DatagramTransport</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="nb">repr</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">def</span> <span class="nf">datagram_received</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">addr</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="o">/</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">suppress</span><span class="p">(</span><span class="n">asyncio</span><span class="o">.</span><span class="n">QueueFull</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">recv_queue</span><span class="o">.</span><span class="n">put_nowait</span><span class="p">(([</span><span class="n">data</span><span class="p">],</span> <span class="n">addr</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">connection_lost</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="ne">Exception</span><span class="p">],</span> <span class="o">/</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">send</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">parts</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">bytes</span><span class="p">],</span>
        <span class="o">/</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">address</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">transport</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">RemoteCallError</span><span class="p">(</span><span class="s1">&#39;transport is not yet open&#39;</span><span class="p">)</span>
        <span class="k">async</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_maybe_reopen</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">parts</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">transport</span><span class="o">.</span><span class="n">sendto</span><span class="p">(</span><span class="n">part</span><span class="p">,</span> <span class="n">addr</span><span class="o">=</span><span class="n">address</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send_count</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">open</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">/</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_running_loop</span><span class="p">()</span>
        <span class="n">kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="p">(</span><span class="s1">&#39;local_addr&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bind</span> <span class="k">else</span> <span class="s1">&#39;remote_addr&#39;</span><span class="p">):</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">),</span>
            <span class="s1">&#39;reuse_port&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s1">&#39;family&#39;</span><span class="p">:</span> <span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">transport</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="k">await</span> <span class="n">loop</span><span class="o">.</span><span class="n">create_datagram_endpoint</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transport</span> <span class="o">=</span> <span class="n">typing</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">asyncio</span><span class="o">.</span><span class="n">DatagramTransport</span><span class="p">,</span> <span class="n">transport</span><span class="p">)</span>
        <span class="n">sock</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transport</span><span class="o">.</span><span class="n">get_extra_info</span><span class="p">(</span><span class="s1">&#39;socket&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">level</span><span class="p">,</span> <span class="n">option</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">:</span>
            <span class="n">sock</span><span class="o">.</span><span class="n">setsockopt</span><span class="p">(</span><span class="n">level</span><span class="p">,</span> <span class="n">option</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">/</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">transport</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">transport</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">closed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">/</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">transport</span><span class="o">.</span><span class="n">is_closing</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">transport</span> <span class="k">else</span> <span class="kc">True</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">can_recv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">/</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span>

<div class="viewcode-block" id="DatagramNode.from_address"><a class="viewcode-back" href="../../api-reference/remote.html#runtime.log.DatagramNode.from_address">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_address</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="o">/</span><span class="p">,</span>
        <span class="n">address</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">bind</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">options</span><span class="p">:</span> <span class="n">Collection</span><span class="p">[</span><span class="n">SocketOptionType</span><span class="p">]</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">(),</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;DatagramNode&#39;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Build a datagram node from an address.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            address: The address to parse, in the form ``udp://[hostname[:port]]``.</span>
<span class="sd">            bind: True if this is a local address (socket is bound). False for a remote</span>
<span class="sd">                address (socket connects).</span>
<span class="sd">            options: Socket options passed to :class:`DatagramNode`.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If the address is not a valid UDP address.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">components</span> <span class="o">=</span> <span class="n">urlsplit</span><span class="p">(</span><span class="n">address</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">components</span><span class="o">.</span><span class="n">scheme</span> <span class="o">!=</span> <span class="s1">&#39;udp&#39;</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">components</span><span class="o">.</span><span class="n">hostname</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">components</span><span class="o">.</span><span class="n">port</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;must provide a UDP address&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">DatagramNode</span><span class="p">(</span>
            <span class="n">host</span><span class="o">=</span><span class="n">components</span><span class="o">.</span><span class="n">hostname</span><span class="p">,</span>
            <span class="n">port</span><span class="o">=</span><span class="n">components</span><span class="o">.</span><span class="n">port</span><span class="p">,</span>
            <span class="n">bind</span><span class="o">=</span><span class="n">bind</span><span class="p">,</span>
            <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">,</span>
        <span class="p">)</span></div></div>


<div class="viewcode-block" id="SocketNode"><a class="viewcode-back" href="../../api-reference/remote.html#runtime.log.SocketNode">[docs]</a><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">SocketNode</span><span class="p">(</span><span class="n">Node</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A wrapper around :class:`zmq.asyncio.Socket` for handling timeouts.</span>

<span class="sd">    When the underlying socket of a :class:`SocketNode` times out, the socket is closed</span>
<span class="sd">    and rebuilt to reset socket&#39;s internal state. For example, a ``REQ`` socket may</span>
<span class="sd">    become stuck in the &quot;listening&quot; state indefinitely if the message it sent gets lost.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        socket_type: The socket type (a constant defined under :mod:`zmq`).</span>
<span class="sd">        subscriptions: A set of topics to subscribe to (for ``SUB`` sockets only).</span>
<span class="sd">        options: A mapping of `ZMQ socket option symbols</span>
<span class="sd">            &lt;http://api.zeromq.org/4-3:zmq-setsockopt&gt;`_ to their values.</span>
<span class="sd">        connections: A set of addresses to connect to.</span>
<span class="sd">        bindings: A set of addresses to bind to.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">socket_type</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">zmq</span><span class="o">.</span><span class="n">DEALER</span>
    <span class="n">options</span><span class="p">:</span> <span class="n">SocketOptions</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
    <span class="n">bindings</span><span class="p">:</span> <span class="nb">frozenset</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">()</span>
    <span class="n">connections</span><span class="p">:</span> <span class="nb">frozenset</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">()</span>
    <span class="n">subscriptions</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">set</span><span class="p">)</span>
    <span class="n">socket</span><span class="p">:</span> <span class="n">zmq</span><span class="o">.</span><span class="n">asyncio</span><span class="o">.</span><span class="n">Socket</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="nb">repr</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">recv_task</span><span class="p">:</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Future</span><span class="p">[</span><span class="n">NoReturn</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span>
        <span class="n">default_factory</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_running_loop</span><span class="p">()</span><span class="o">.</span><span class="n">create_future</span><span class="p">(),</span>
        <span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="nb">repr</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">def</span> <span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">/</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># TODO: remove this type coercion</span>
        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;bindings&#39;</span><span class="p">,</span> <span class="s1">&#39;connections&#39;</span><span class="p">,</span> <span class="s1">&#39;subscriptions&#39;</span><span class="p">):</span>
            <span class="n">value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="p">{</span><span class="n">value</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bindings</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bindings</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connections</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">connections</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">socket_type</span> <span class="o">==</span> <span class="n">zmq</span><span class="o">.</span><span class="n">SUB</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">subscriptions</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">subscriptions</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">socket_type</span> <span class="o">==</span> <span class="n">zmq</span><span class="o">.</span><span class="n">DEALER</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">zmq</span><span class="o">.</span><span class="n">PROBE_ROUTER</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">socket_type</span> <span class="o">==</span> <span class="n">zmq</span><span class="o">.</span><span class="n">ROUTER</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">zmq</span><span class="o">.</span><span class="n">ROUTER_HANDOVER</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">identity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">/</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;The ZMQ identity of this socket.&quot;&quot;&quot;</span>
        <span class="n">ident</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">zmq</span><span class="o">.</span><span class="n">IDENTITY</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ident</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ident</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">)</span> <span class="k">else</span> <span class="sa">b</span><span class="s1">&#39;(anonymous)&#39;</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">send</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">parts</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">bytes</span><span class="p">],</span>
        <span class="o">/</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">address</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bytes</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">address</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">RemoteCallError</span><span class="p">(</span><span class="s1">&#39;must provide an address&#39;</span><span class="p">)</span>
        <span class="k">async</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_maybe_reopen</span><span class="p">(</span><span class="n">zmq</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">Again</span><span class="p">):</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">send_multipart</span><span class="p">([</span><span class="n">address</span><span class="p">,</span> <span class="o">*</span><span class="n">parts</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send_count</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_recv_forever</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">/</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NoReturn</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Receive messages indefinitely and enqueue them.&quot;&quot;&quot;</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">suppress</span><span class="p">(</span><span class="n">RemoteCallError</span><span class="p">):</span>
                <span class="k">async</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_maybe_reopen</span><span class="p">(</span><span class="n">zmq</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">Again</span><span class="p">):</span>
                    <span class="n">sender_id</span><span class="p">,</span> <span class="o">*</span><span class="n">frames</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">recv_multipart</span><span class="p">()</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">socket_type</span> <span class="o">==</span> <span class="n">zmq</span><span class="o">.</span><span class="n">SUB</span><span class="p">:</span>
                        <span class="n">sender_id</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span>
                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">recv_queue</span><span class="o">.</span><span class="n">put</span><span class="p">((</span><span class="nb">list</span><span class="p">(</span><span class="n">frames</span><span class="p">),</span> <span class="n">sender_id</span><span class="p">))</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">open</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">/</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ctx</span> <span class="o">=</span> <span class="n">zmq</span><span class="o">.</span><span class="n">asyncio</span><span class="o">.</span><span class="n">Context</span><span class="o">.</span><span class="n">instance</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">socket</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">socket_type</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">address</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bindings</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="n">address</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">address</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">connections</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">address</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">socket_type</span> <span class="o">==</span> <span class="n">zmq</span><span class="o">.</span><span class="n">SUB</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">topic</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">subscriptions</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="n">topic</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">can_recv</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">recv_task</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_recv_forever</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;recv&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">/</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">recv_task</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">closed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">/</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">closed</span><span class="p">)</span> <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;socket&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="k">else</span> <span class="kc">True</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">can_recv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">/</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">socket_type</span> <span class="o">!=</span> <span class="n">zmq</span><span class="o">.</span><span class="n">PUB</span>

<div class="viewcode-block" id="SocketNode.subscribe"><a class="viewcode-back" href="../../api-reference/remote.html#runtime.log.SocketNode.subscribe">[docs]</a>    <span class="k">def</span> <span class="nf">subscribe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">/</span><span class="p">,</span> <span class="n">topic</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Subscribe to a topic (for ``zmq.SUB`` sockets only).</span>

<span class="sd">        Parameters:</span>
<span class="sd">            topic: The topic to subscribe to.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">socket_type</span> <span class="o">==</span> <span class="n">zmq</span><span class="o">.</span><span class="n">SUB</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="n">topic</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">subscriptions</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">topic</span><span class="p">)</span></div>

<div class="viewcode-block" id="SocketNode.unsubscribe"><a class="viewcode-back" href="../../api-reference/remote.html#runtime.log.SocketNode.unsubscribe">[docs]</a>    <span class="k">def</span> <span class="nf">unsubscribe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">/</span><span class="p">,</span> <span class="n">topic</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Unsubscribe from a topic (for ``zmq.SUB`` sockets only).</span>

<span class="sd">        Parameters:</span>
<span class="sd">            topic: The topic to unsubscribe from.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">socket_type</span> <span class="o">==</span> <span class="n">zmq</span><span class="o">.</span><span class="n">SUB</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">unsubscribe</span><span class="p">(</span><span class="n">topic</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">subscriptions</span><span class="o">.</span><span class="n">discard</span><span class="p">(</span><span class="n">topic</span><span class="p">)</span></div>

<div class="viewcode-block" id="SocketNode.set_option"><a class="viewcode-back" href="../../api-reference/remote.html#runtime.log.SocketNode.set_option">[docs]</a>    <span class="k">def</span> <span class="nf">set_option</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">option</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">],</span> <span class="o">/</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Set a socket option.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            option: A socket option symbol defined by :mod:`zmq`.</span>
<span class="sd">            value: The option value (the type/format depends on the option).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">option</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="n">option</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span></div></div>


<span class="k">def</span> <span class="nf">_check_type</span><span class="p">(</span><span class="n">node</span><span class="p">:</span> <span class="n">Node</span><span class="p">,</span> <span class="o">/</span><span class="p">,</span> <span class="o">*</span><span class="n">allowed_types</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Raise a :class:`RemoteCallError` if this socket type is not allowed.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">SocketNode</span><span class="p">)</span> <span class="ow">and</span> <span class="n">node</span><span class="o">.</span><span class="n">socket_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">allowed_types</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">RemoteCallError</span><span class="p">(</span>
            <span class="s1">&#39;socket type not allowed&#39;</span><span class="p">,</span>
            <span class="n">socket_type</span><span class="o">=</span><span class="n">node</span><span class="o">.</span><span class="n">socket_type</span><span class="p">,</span>
            <span class="n">allowed_types</span><span class="o">=</span><span class="n">allowed_types</span><span class="p">,</span>
        <span class="p">)</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">_encode</span><span class="p">(</span><span class="n">obj</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="o">/</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Encode an object as a CBOR-encoded buffer in the default executor.</span>

<span class="sd">    Raises:</span>
<span class="sd">        cbor2.CBOREncodeError: If the encoding fails.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">to_thread</span><span class="p">(</span><span class="n">cbor2</span><span class="o">.</span><span class="n">dumps</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">_decode</span><span class="p">(</span><span class="n">buf</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">,</span> <span class="o">/</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Decode a CBOR-encoded buffer in the default executor.</span>

<span class="sd">    Raises:</span>
<span class="sd">        cbor2.CBORDecodeError: If the decoding fails.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">to_thread</span><span class="p">(</span><span class="n">cbor2</span><span class="o">.</span><span class="n">loads</span><span class="p">,</span> <span class="n">buf</span><span class="p">)</span>


<span class="n">Method</span> <span class="o">=</span> <span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>


<span class="k">class</span> <span class="nc">RemoteMethod</span><span class="p">(</span><span class="n">Protocol</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A remotely callable method (any signature, any return value).&quot;&quot;&quot;</span>

    <span class="n">__remote__</span><span class="p">:</span> <span class="nb">str</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">/</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="o">...</span>


<span class="nd">@typing</span><span class="o">.</span><span class="n">overload</span>
<span class="k">def</span> <span class="nf">route</span><span class="p">(</span><span class="n">method_or_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">/</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Method</span><span class="p">],</span> <span class="n">RemoteMethod</span><span class="p">]:</span>
    <span class="o">...</span>


<span class="nd">@typing</span><span class="o">.</span><span class="n">overload</span>
<span class="k">def</span> <span class="nf">route</span><span class="p">(</span><span class="n">method_or_name</span><span class="p">:</span> <span class="n">Method</span><span class="p">,</span> <span class="o">/</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RemoteMethod</span><span class="p">:</span>
    <span class="o">...</span>


<div class="viewcode-block" id="route"><a class="viewcode-back" href="../../api-reference/remote.html#runtime.log.route">[docs]</a><span class="k">def</span> <span class="nf">route</span><span class="p">(</span>
    <span class="n">method_or_name</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Method</span><span class="p">],</span>
    <span class="o">/</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">RemoteMethod</span><span class="p">,</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Method</span><span class="p">],</span> <span class="n">RemoteMethod</span><span class="p">]]:</span>
    <span class="sd">&quot;&quot;&quot;Decorator for marking a bound method as an RPC target.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        method_or_name: Either the method to be registered or the name it should be</span>
<span class="sd">            registered under. If the former, the method name is exposed to the</span>
<span class="sd">            :class:`Handler`. The latter is useful for exposing a name that is not a</span>
<span class="sd">            valid Python identifier.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Either an identity decorator (if a name was provided) or the method provided.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">method_or_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>

        <span class="k">def</span> <span class="nf">decorator</span><span class="p">(</span><span class="n">method</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">RemoteMethod</span><span class="p">:</span>
            <span class="n">remote_method</span> <span class="o">=</span> <span class="n">typing</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">RemoteMethod</span><span class="p">,</span> <span class="n">method</span><span class="p">)</span>
            <span class="n">remote_method</span><span class="o">.</span><span class="n">__remote__</span> <span class="o">=</span> <span class="n">typing</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">method_or_name</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">remote_method</span>

        <span class="k">return</span> <span class="n">decorator</span>
    <span class="n">remote_method</span> <span class="o">=</span> <span class="n">typing</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">RemoteMethod</span><span class="p">,</span> <span class="n">method_or_name</span><span class="p">)</span>
    <span class="n">remote_method</span><span class="o">.</span><span class="n">__remote__</span> <span class="o">=</span> <span class="n">method_or_name</span><span class="o">.</span><span class="vm">__name__</span>
    <span class="k">return</span> <span class="n">remote_method</span></div>


<div class="viewcode-block" id="Endpoint"><a class="viewcode-back" href="../../api-reference/remote.html#runtime.log.Endpoint">[docs]</a><span class="nd">@dataclass</span>  <span class="c1"># type: ignore[misc]</span>
<span class="k">class</span> <span class="nc">Endpoint</span><span class="p">(</span><span class="n">abc</span><span class="o">.</span><span class="n">ABC</span><span class="p">):</span>  <span class="c1"># https://github.com/python/mypy/issues/5374</span>
    <span class="sd">&quot;&quot;&quot;A source or destination of messages.</span>

<span class="sd">    An :class:`Endpoint` has a number of workers (instances of :class:`asyncio.Task`)</span>
<span class="sd">    that listen for and process incoming messages. This allows for request pipelining.</span>
<span class="sd">    Once all workers are busy processing messages, the node wrapped by the endpoint</span>
<span class="sd">    buffers any additional messages.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        node: The message transceiver. Not all node/endpoint pairs are compatible.</span>
<span class="sd">        concurrency: The number of workers.</span>
<span class="sd">        logger: A logger instance.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">node</span><span class="p">:</span> <span class="n">Node</span>
    <span class="n">concurrency</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">logger</span><span class="p">:</span> <span class="n">structlog</span><span class="o">.</span><span class="n">stdlib</span><span class="o">.</span><span class="n">AsyncBoundLogger</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="n">get_logger</span><span class="p">)</span>
    <span class="n">stack</span><span class="p">:</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">AsyncExitStack</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span>
        <span class="n">default_factory</span><span class="o">=</span><span class="n">contextlib</span><span class="o">.</span><span class="n">AsyncExitStack</span><span class="p">,</span>
        <span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="nb">repr</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">def</span> <span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">/</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">concurrency</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;concurrency must be a positive integer&#39;</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="fm">__aenter__</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">EndpointType</span><span class="p">,</span> <span class="o">/</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">EndpointType</span><span class="p">:</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="fm">__aenter__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">enter_async_context</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">concurrency</span><span class="p">):</span>
            <span class="n">worker</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_process_forever</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;process-msg&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">callback</span><span class="p">(</span><span class="n">worker</span><span class="o">.</span><span class="n">cancel</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">async</span> <span class="k">def</span> <span class="fm">__aexit__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">exc_type</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">type</span><span class="p">[</span><span class="ne">BaseException</span><span class="p">]],</span>
        <span class="n">exc</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="ne">BaseException</span><span class="p">],</span>
        <span class="n">traceback</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">types</span><span class="o">.</span><span class="n">TracebackType</span><span class="p">],</span>
        <span class="o">/</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]:</span>
        <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="fm">__aexit__</span><span class="p">(</span><span class="n">exc_type</span><span class="p">,</span> <span class="n">exc</span><span class="p">,</span> <span class="n">traceback</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_process_forever</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">/</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">cooldown</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NoReturn</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Receive messages indefinitely and process them.&quot;&quot;&quot;</span>
        <span class="n">logger</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">bind</span><span class="p">()</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">frames</span><span class="p">,</span> <span class="n">address</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>
                <span class="n">payload</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span> <span class="o">=</span> <span class="n">frames</span>
                <span class="n">message_type</span><span class="p">,</span> <span class="o">*</span><span class="n">message</span> <span class="o">=</span> <span class="k">await</span> <span class="n">_decode</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
                <span class="n">message_type</span> <span class="o">=</span> <span class="n">MessageType</span><span class="p">(</span><span class="n">message_type</span><span class="p">)</span>
                <span class="k">await</span> <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="s1">&#39;Endpoint received message&#39;</span><span class="p">,</span> <span class="n">message_type</span><span class="o">=</span><span class="n">message_type</span><span class="o">.</span><span class="n">name</span>
                <span class="p">)</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_message</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">message_type</span><span class="p">,</span> <span class="o">*</span><span class="n">message</span><span class="p">)</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">cbor2</span><span class="o">.</span><span class="n">CBORDecodeError</span><span class="p">,</span> <span class="n">RemoteCallError</span><span class="p">)</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Endpoint failed to process message&#39;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="n">exc</span><span class="p">)</span>
                <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">cooldown</span><span class="p">)</span>

<div class="viewcode-block" id="Endpoint.handle_message"><a class="viewcode-back" href="../../api-reference/remote.html#runtime.log.Endpoint.handle_message">[docs]</a>    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">handle_message</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">address</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">message_type</span><span class="p">:</span> <span class="n">MessageType</span><span class="p">,</span> <span class="o">*</span><span class="n">message</span><span class="p">:</span> <span class="n">Any</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Process a message.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            address: The address of the message&#39;s sender, if available. The semantics</span>
<span class="sd">                depend on the node. Pass this argument directly to :meth:`Node.send`.</span>
<span class="sd">            message_type: The message type.</span>
<span class="sd">            message: Other message parts. The message type determines the format.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If the endpoint could not unpack part of the message.</span>
<span class="sd">            RemoteCallError: If the endpoint could not otherwise process the message.</span>
<span class="sd">        &quot;&quot;&quot;</span></div></div>


<span class="n">ResponseType</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s1">&#39;ResponseType&#39;</span><span class="p">)</span>


<div class="viewcode-block" id="RequestTracker"><a class="viewcode-back" href="../../api-reference/remote.html#runtime.log.RequestTracker">[docs]</a><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">RequestTracker</span><span class="p">(</span><span class="n">Generic</span><span class="p">[</span><span class="n">ResponseType</span><span class="p">]):</span>
    <span class="sd">&quot;&quot;&quot;Track outstanding requests and their results.</span>

<span class="sd">    Every request is associated with a unique request ID (an integer, or an object</span>
<span class="sd">    serializable as an integer).</span>

<span class="sd">    Parameters:</span>
<span class="sd">        futures: A mapping from request IDs to futures representing responses.</span>
<span class="sd">        lower: Minimum valid request ID.</span>
<span class="sd">        upper: Maximum valid request ID.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">futures</span><span class="p">:</span> <span class="n">MutableMapping</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Future</span><span class="p">[</span><span class="n">ResponseType</span><span class="p">]]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span>
        <span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">lower</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">upper</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">_try_generate_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">/</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Attempt to generate a request ID.</span>

<span class="sd">        Unlike :meth:`generate_uid`, the candidate ID does not need to be unique.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lower</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">upper</span><span class="p">)</span>

<div class="viewcode-block" id="RequestTracker.generate_uid"><a class="viewcode-back" href="../../api-reference/remote.html#runtime.log.RequestTracker.generate_uid">[docs]</a>    <span class="k">def</span> <span class="nf">generate_uid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">/</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">attempts</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Generate a unique request ID.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            attempts: The maximum number of times to try to generate an ID.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If the tracker could not generate a unique ID. If the ID space</span>
<span class="sd">                is sufficiently large, this error is exceedingly rare. Increasing the</span>
<span class="sd">                number of attempts or decreasing the number of in-flight requests should</span>
<span class="sd">                increase the probability of a unique ID.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">attempts</span><span class="p">):</span>
            <span class="n">request_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_try_generate_id</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">request_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">futures</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">request_id</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;unable to generate a request ID&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="RequestTracker.new_request"><a class="viewcode-back" href="../../api-reference/remote.html#runtime.log.RequestTracker.new_request">[docs]</a>    <span class="nd">@contextlib</span><span class="o">.</span><span class="n">contextmanager</span>
    <span class="k">def</span> <span class="nf">new_request</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="o">/</span><span class="p">,</span>
        <span class="n">request_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Future</span><span class="p">[</span><span class="n">ResponseType</span><span class="p">]]]:</span>
        <span class="sd">&quot;&quot;&quot;Register a new request.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            request_id: A unique request identifier. If not provided, a request ID is</span>
<span class="sd">                randomly generated.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The request ID and a future representing the outcome of the request.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">request_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">request_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_uid</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">request_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">futures</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;request ID already exists&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">futures</span><span class="p">[</span><span class="n">request_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_running_loop</span><span class="p">()</span><span class="o">.</span><span class="n">create_future</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">request_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">futures</span><span class="p">[</span><span class="n">request_id</span><span class="p">]</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">futures</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">request_id</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span></div>

<div class="viewcode-block" id="RequestTracker.register_response"><a class="viewcode-back" href="../../api-reference/remote.html#runtime.log.RequestTracker.register_response">[docs]</a>    <span class="k">def</span> <span class="nf">register_response</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="o">/</span><span class="p">,</span>
        <span class="n">request_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">result</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="ne">BaseException</span><span class="p">,</span> <span class="n">ResponseType</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Register a request&#39;s response.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            request_id: The request identifier returned from :meth:`new_request`.</span>
<span class="sd">            result: The response or exception.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">future</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">futures</span><span class="p">[</span><span class="n">request_id</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="ne">BaseException</span><span class="p">):</span>
            <span class="n">future</span><span class="o">.</span><span class="n">set_exception</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">future</span><span class="o">.</span><span class="n">set_result</span><span class="p">(</span><span class="n">result</span><span class="p">)</span></div></div>


<span class="n">Call</span> <span class="o">=</span> <span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">Awaitable</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span>


<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">CallFactory</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A wrapper class around the call factory.</span>

<span class="sd">    This wrapper uses currying to partially complete the argument list to</span>
<span class="sd">    :meth:`Client.issue_call`.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">issue_call</span><span class="p">:</span> <span class="n">Call</span>
    <span class="n">cached_partial</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">str</span><span class="p">],</span> <span class="n">Call</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="nb">repr</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">make_cached</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">lru_cache</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="mi">128</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cached_partial</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">str</span><span class="p">],</span> <span class="n">Call</span><span class="p">]</span> <span class="o">=</span> <span class="n">make_cached</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_partial</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_partial</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Call</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">issue_call</span><span class="p">,</span> <span class="n">method</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Call</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cached_partial</span><span class="p">(</span><span class="n">method</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Call</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cached_partial</span><span class="p">(</span><span class="n">method</span><span class="p">)</span>


<div class="viewcode-block" id="Client"><a class="viewcode-back" href="../../api-reference/remote.html#runtime.log.Client">[docs]</a><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">Client</span><span class="p">(</span><span class="n">Endpoint</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;An endpoint for issuing remote calls.</span>

<span class="sd">    A request is matched to its response with a message ID, a 32-bit integer unique</span>
<span class="sd">    among in-flight requests at any given time.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        requests: Stores in-flight message IDs to futures. Each future represents the</span>
<span class="sd">            outcome of a call (a result or an exception).</span>
<span class="sd">        node: A node for transporting messages.</span>
<span class="sd">        concurrency: The number of workers for processing responses.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">requests</span><span class="p">:</span> <span class="n">RequestTracker</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="n">RequestTracker</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">/</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">_check_type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="p">,</span> <span class="n">zmq</span><span class="o">.</span><span class="n">PUB</span><span class="p">,</span> <span class="n">zmq</span><span class="o">.</span><span class="n">DEALER</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">can_recv</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">concurrency</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__post_init__</span><span class="p">()</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">handle_message</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">address</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
        <span class="n">message_type</span><span class="p">:</span> <span class="n">MessageType</span><span class="p">,</span>
        <span class="o">/</span><span class="p">,</span>
        <span class="o">*</span><span class="n">message</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">message_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">MessageType</span><span class="o">.</span><span class="n">RESPONSE</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">RemoteCallError</span><span class="p">(</span>
                <span class="s1">&#39;client only receives RESPONSE messages&#39;</span><span class="p">,</span>
                <span class="n">message_type</span><span class="o">=</span><span class="n">message_type</span><span class="p">,</span>
                <span class="n">message_parts</span><span class="o">=</span><span class="n">message</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="n">message_id</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="n">result</span> <span class="o">=</span> <span class="n">message</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">error</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">error_message</span><span class="p">,</span> <span class="n">context</span> <span class="o">=</span> <span class="n">error</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">RemoteCallError</span><span class="p">(</span><span class="n">error_message</span><span class="p">,</span> <span class="o">**</span><span class="n">context</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">requests</span><span class="o">.</span><span class="n">register_response</span><span class="p">(</span><span class="n">message_id</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">RemoteCallError</span><span class="p">(</span>
                <span class="s1">&#39;client received unexpected response&#39;</span><span class="p">,</span>
                <span class="n">message_id</span><span class="o">=</span><span class="n">message_id</span><span class="p">,</span>
            <span class="p">)</span> <span class="kn">from</span> <span class="nn">exc</span>

<div class="viewcode-block" id="Client.issue_call"><a class="viewcode-back" href="../../api-reference/remote.html#runtime.log.Client.issue_call">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">issue_call</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">method</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="o">/</span><span class="p">,</span>
        <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
        <span class="n">address</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">notification</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">timeout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Issue a remote procedure call and possibly wait for the result.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            method: Method name.</span>
<span class="sd">            args: Method arguments.</span>
<span class="sd">            address: A transport-dependent address.</span>
<span class="sd">            notification: False iff this call requires a response. Has no effect for</span>
<span class="sd">                nodes that cannot receive data, which can *only* send notifications.</span>
<span class="sd">            timeout: Maximum duration (in seconds) to wait for a response.</span>

<span class="sd">        Raises:</span>
<span class="sd">            asyncio.TimeoutError: The request was successfully sent, but the response</span>
<span class="sd">                never arrived in time.</span>
<span class="sd">            ValueError: If the request tracker could not generate a unique message ID.</span>
<span class="sd">            RemoteCallError: If the service returned an error.</span>
<span class="sd">            cbor2.CBOREncodeError: If the arguments were not serializable.</span>

<span class="sd">        Note:</span>
<span class="sd">            Notification calls will not raise an exception client-side if the server</span>
<span class="sd">            fails, even if the node supports duplex communication.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">can_recv</span><span class="p">:</span>
            <span class="n">notification</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="p">,</span> <span class="n">SocketNode</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">socket_type</span> <span class="o">==</span> <span class="n">zmq</span><span class="o">.</span><span class="n">PUB</span><span class="p">:</span>
            <span class="n">address</span> <span class="o">=</span> <span class="n">address</span> <span class="ow">or</span> <span class="n">method</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s1">&#39;Issuing remote procedure call&#39;</span><span class="p">,</span>
            <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span>
            <span class="n">notification</span><span class="o">=</span><span class="n">notification</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">notification</span><span class="p">:</span>
            <span class="n">request</span> <span class="o">=</span> <span class="p">[</span><span class="n">MessageType</span><span class="o">.</span><span class="n">NOTIFICATION</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">args</span><span class="p">]</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">send</span><span class="p">([</span><span class="k">await</span> <span class="n">_encode</span><span class="p">(</span><span class="n">request</span><span class="p">)],</span> <span class="n">address</span><span class="o">=</span><span class="n">address</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">requests</span><span class="o">.</span><span class="n">new_request</span><span class="p">()</span> <span class="k">as</span> <span class="p">(</span><span class="n">message_id</span><span class="p">,</span> <span class="n">result</span><span class="p">):</span>
                <span class="n">request</span> <span class="o">=</span> <span class="p">[</span><span class="n">MessageType</span><span class="o">.</span><span class="n">REQUEST</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">message_id</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">args</span><span class="p">]</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">send</span><span class="p">([</span><span class="k">await</span> <span class="n">_encode</span><span class="p">(</span><span class="n">request</span><span class="p">)],</span> <span class="n">address</span><span class="o">=</span><span class="n">address</span><span class="p">)</span>
                <span class="k">return</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">wait_for</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">timeout</span><span class="p">)</span></div>

    <span class="nd">@functools</span><span class="o">.</span><span class="n">cached_property</span>
    <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">/</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">CallFactory</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Syntactic sugar for issuing remote procedure calls.</span>

<span class="sd">        Instead of::</span>

<span class="sd">            await client.issue_call(&#39;add&#39;, 1, 2)</span>

<span class="sd">        Replace with either of::</span>

<span class="sd">            await client.call.add(1, 2)</span>
<span class="sd">            await client.call[&#39;add&#39;](1, 2)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">CallFactory</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">issue_call</span><span class="p">)</span></div>


<div class="viewcode-block" id="Handler"><a class="viewcode-back" href="../../api-reference/remote.html#runtime.log.Handler">[docs]</a><span class="k">class</span> <span class="nc">Handler</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;An object whose bound methods are exposed to remote callers.</span>

<span class="sd">    Define a handler by subclassing :class:`Handler` and applying the :func:`route`</span>
<span class="sd">    decorator:</span>

<span class="sd">    &gt;&gt;&gt; class CustomHandler(Handler):</span>
<span class="sd">    ...     @route</span>
<span class="sd">    ...     async def method1(self, arg: int) -&gt; int:</span>
<span class="sd">    ...         ...</span>
<span class="sd">    ...     @route(&#39;non-python-identifier&#39;)</span>
<span class="sd">    ...     def method2(self):</span>
<span class="sd">    ...         ...</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@functools</span><span class="o">.</span><span class="n">cached_property</span>
    <span class="k">def</span> <span class="nf">_method_table</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">MethodType</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;A mapping of method names to (possibly coroutine) bound methods.&quot;&quot;&quot;</span>
        <span class="c1"># Need to use the class to avoid calling `getattr(...)` on this property.</span>
        <span class="c1"># Accessing bound methods directly can lead to infinite recursion.</span>
        <span class="n">funcs</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getmembers</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isfunction</span><span class="p">)</span>
        <span class="n">funcs</span> <span class="o">=</span> <span class="p">[(</span><span class="n">attr</span><span class="p">,</span> <span class="n">func</span><span class="p">)</span> <span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">func</span> <span class="ow">in</span> <span class="n">funcs</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="s1">&#39;__remote__&#39;</span><span class="p">)]</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">func</span><span class="o">.</span><span class="n">__remote__</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span> <span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">func</span> <span class="ow">in</span> <span class="n">funcs</span><span class="p">}</span>

<div class="viewcode-block" id="Handler.dispatch"><a class="viewcode-back" href="../../api-reference/remote.html#runtime.log.Handler.dispatch">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">dispatch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">30</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Dispatch a remote procedure call.</span>

<span class="sd">        If the method is synchronous (possibly blocking), the default executor performs</span>
<span class="sd">        the call.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            method: The procedure name.</span>
<span class="sd">            args: Positional arguments for the procedure.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The procedure&#39;s result, which must be CBOR-serializable.</span>

<span class="sd">        Raises:</span>
<span class="sd">            RemoteCallError: The procedure call does not exist, timed out, or raised an</span>
<span class="sd">                exception.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">func</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_method_table</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">method</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">func</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">RemoteCallError</span><span class="p">(</span><span class="s1">&#39;no such method exists&#39;</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">inspect</span><span class="o">.</span><span class="n">iscoroutinefunction</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
                <span class="n">call</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">call</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">to_thread</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
            <span class="k">return</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">wait_for</span><span class="p">(</span><span class="n">call</span><span class="p">,</span> <span class="n">timeout</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">TimeoutError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">RemoteCallError</span><span class="p">(</span><span class="s1">&#39;method timed out&#39;</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">exc</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">RemoteCallError</span><span class="p">(</span><span class="s1">&#39;method produced an error&#39;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">exc</span></div></div>


<div class="viewcode-block" id="Service"><a class="viewcode-back" href="../../api-reference/remote.html#runtime.log.Service">[docs]</a><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">Service</span><span class="p">(</span><span class="n">Endpoint</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Responds to RPC requests.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        handler: The object whose bound methods this service will call.</span>
<span class="sd">        timeout: Maximum duration (in seconds) to execute methods for.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">handler</span><span class="p">:</span> <span class="n">Handler</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="n">Handler</span><span class="p">)</span>
    <span class="n">timeout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">30</span>

    <span class="k">def</span> <span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">_check_type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="p">,</span> <span class="n">zmq</span><span class="o">.</span><span class="n">SUB</span><span class="p">,</span> <span class="n">zmq</span><span class="o">.</span><span class="n">DEALER</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">handle_message</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">address</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">message_type</span><span class="p">:</span> <span class="n">MessageType</span><span class="p">,</span> <span class="o">*</span><span class="n">message</span><span class="p">:</span> <span class="n">Any</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">message_type</span> <span class="ow">is</span> <span class="n">MessageType</span><span class="o">.</span><span class="n">REQUEST</span><span class="p">:</span>
            <span class="n">message_id</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">args</span> <span class="o">=</span> <span class="n">message</span>
        <span class="k">elif</span> <span class="n">message_type</span> <span class="ow">is</span> <span class="n">MessageType</span><span class="o">.</span><span class="n">NOTIFICATION</span><span class="p">:</span>
            <span class="n">message_id</span><span class="p">,</span> <span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">message</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s1">&#39;Service does not support message&#39;</span><span class="p">,</span>
                <span class="n">message_type</span><span class="o">=</span><span class="n">message_type</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">return</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">handler</span><span class="o">.</span><span class="n">dispatch</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">)</span>
            <span class="n">error</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">except</span> <span class="n">RemoteCallError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="n">result</span><span class="p">,</span> <span class="n">error</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">exc</span><span class="p">),</span> <span class="n">exc</span><span class="o">.</span><span class="n">context</span><span class="p">]</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s1">&#39;Service was unable to execute call&#39;</span><span class="p">,</span>
                <span class="n">message_type</span><span class="o">=</span><span class="n">message_type</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="n">message_id</span><span class="o">=</span><span class="n">message_id</span><span class="p">,</span>
                <span class="n">exc_info</span><span class="o">=</span><span class="n">exc</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">message_type</span> <span class="ow">is</span> <span class="n">MessageType</span><span class="o">.</span><span class="n">REQUEST</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="p">[</span><span class="n">MessageType</span><span class="o">.</span><span class="n">RESPONSE</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">message_id</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="n">result</span><span class="p">]</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">send</span><span class="p">([</span><span class="k">await</span> <span class="n">_encode</span><span class="p">(</span><span class="n">response</span><span class="p">)],</span> <span class="n">address</span><span class="o">=</span><span class="n">address</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">_render_id</span><span class="p">(</span><span class="n">identity</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">suppress</span><span class="p">(</span><span class="ne">UnicodeDecodeError</span><span class="p">):</span>
        <span class="n">decoded</span> <span class="o">=</span> <span class="n">identity</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">decoded</span><span class="o">.</span><span class="n">isprintable</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">decoded</span>
    <span class="k">return</span> <span class="n">identity</span><span class="o">.</span><span class="n">hex</span><span class="p">()</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">_route</span><span class="p">(</span><span class="n">recv_socket</span><span class="p">:</span> <span class="n">SocketNode</span><span class="p">,</span> <span class="n">send_socket</span><span class="p">:</span> <span class="n">SocketNode</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">NoReturn</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Route messages in one direction.</span>

<span class="sd">    A :class:`Router` is duplex, but the frame format and implementation for each</span>
<span class="sd">    direction are identical.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        recv_socket: The receiving socket, which indefinitely reads five-frame</span>
<span class="sd">            messages consisting of the sender&#39;s ZMQ identity, the recipient&#39;s</span>
<span class="sd">            identity, and the payload, with empty delimeter frames sandwiched</span>
<span class="sd">            between them.</span>
<span class="sd">        send_socket: The sending socket, which simply transposes the</span>
<span class="sd">            sender/recipient ID frames.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span> <span class="o">=</span> <span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span>
        <span class="n">recv_socket</span><span class="o">=</span><span class="n">_render_id</span><span class="p">(</span><span class="n">recv_socket</span><span class="o">.</span><span class="n">identity</span><span class="p">),</span>
        <span class="n">send_socket</span><span class="o">=</span><span class="n">_render_id</span><span class="p">(</span><span class="n">send_socket</span><span class="o">.</span><span class="n">identity</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="k">await</span> <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Router started&#39;</span><span class="p">)</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">frames</span><span class="p">,</span> <span class="n">sender_id</span> <span class="o">=</span> <span class="k">await</span> <span class="n">recv_socket</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">frames</span> <span class="o">==</span> <span class="p">[</span><span class="sa">b</span><span class="s1">&#39;&#39;</span><span class="p">]:</span>
                <span class="k">await</span> <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="s1">&#39;Router connected to endpoint&#39;</span><span class="p">,</span>
                    <span class="n">sender_id</span><span class="o">=</span><span class="n">_render_id</span><span class="p">(</span><span class="n">sender_id</span><span class="p">),</span>
                <span class="p">)</span>
                <span class="k">continue</span>
            <span class="n">recipient_id</span><span class="p">,</span> <span class="n">payload</span> <span class="o">=</span> <span class="n">frames</span>
            <span class="k">await</span> <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s1">&#39;Router received message&#39;</span><span class="p">,</span>
                <span class="n">sender_id</span><span class="o">=</span><span class="n">_render_id</span><span class="p">(</span><span class="n">sender_id</span><span class="p">),</span>
                <span class="n">recipient_id</span><span class="o">=</span><span class="n">_render_id</span><span class="p">(</span><span class="n">recipient_id</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">sender_id</span> <span class="o">==</span> <span class="n">recipient_id</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                    <span class="s1">&#39;Loopback not allowed&#39;</span><span class="p">,</span>
                    <span class="n">sender_id</span><span class="o">=</span><span class="n">_render_id</span><span class="p">(</span><span class="n">sender_id</span><span class="p">),</span>
                <span class="p">)</span>
                <span class="k">continue</span>
            <span class="k">await</span> <span class="n">send_socket</span><span class="o">.</span><span class="n">send</span><span class="p">([</span><span class="n">sender_id</span><span class="p">,</span> <span class="n">payload</span><span class="p">],</span> <span class="n">address</span><span class="o">=</span><span class="n">recipient_id</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="n">RemoteCallError</span><span class="p">)</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Router failed to route message&#39;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="n">exc</span><span class="p">)</span>


<div class="viewcode-block" id="Router"><a class="viewcode-back" href="../../api-reference/remote.html#runtime.log.Router">[docs]</a><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">Router</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Routes messages between :class:`Client`s and :class:`Service`s that use sockets.</span>

<span class="sd">    Routers are stateless, duplex, and symmetric (*i.e.*, require the same format and</span>
<span class="sd">    exhibit the same behavior on both ends).</span>

<span class="sd">    Routers have no error handling and may silently drop messages if the destination is</span>
<span class="sd">    unreachable. Clients must rely on timeouts to determine when to consider a request</span>
<span class="sd">    failed.</span>

<span class="sd">    The payloads themselves are opaque to the router and are not deserialized.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        frontend: A ``ROUTER`` socket clients connect to.</span>
<span class="sd">        backend: A ``ROUTER`` socket services connect to.</span>
<span class="sd">        route_task: The background task performing the routing. :class:`Router`</span>
<span class="sd">            implements the async context manager protocol, which automatically schedules</span>
<span class="sd">            and cancels this task.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">frontend</span><span class="p">:</span> <span class="n">SocketNode</span>
    <span class="n">backend</span><span class="p">:</span> <span class="n">SocketNode</span>
    <span class="n">route_task</span><span class="p">:</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Future</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">NoReturn</span><span class="p">,</span> <span class="n">NoReturn</span><span class="p">]]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span>
        <span class="n">default_factory</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_running_loop</span><span class="p">()</span><span class="o">.</span><span class="n">create_future</span><span class="p">(),</span>
        <span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="nb">repr</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">def</span> <span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">/</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">_check_type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">frontend</span><span class="p">,</span> <span class="n">zmq</span><span class="o">.</span><span class="n">ROUTER</span><span class="p">)</span>
        <span class="n">_check_type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">backend</span><span class="p">,</span> <span class="n">zmq</span><span class="o">.</span><span class="n">ROUTER</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="fm">__aenter__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">/</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;Router&#39;</span><span class="p">:</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">frontend</span><span class="o">.</span><span class="fm">__aenter__</span><span class="p">()</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="fm">__aenter__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">route_task</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span>
            <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">_route</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">frontend</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">backend</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;route-req&#39;</span><span class="p">),</span>
            <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">_route</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">backend</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">frontend</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;route-res&#39;</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">async</span> <span class="k">def</span> <span class="fm">__aexit__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">exc_type</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">type</span><span class="p">[</span><span class="ne">BaseException</span><span class="p">]],</span>
        <span class="n">exc</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="ne">BaseException</span><span class="p">],</span>
        <span class="n">traceback</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">types</span><span class="o">.</span><span class="n">TracebackType</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">route_task</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">suppress</span><span class="p">(</span><span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span><span class="p">):</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">route_task</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">frontend</span><span class="o">.</span><span class="fm">__aexit__</span><span class="p">(</span><span class="n">exc_type</span><span class="p">,</span> <span class="n">exc</span><span class="p">,</span> <span class="n">traceback</span><span class="p">)</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="fm">__aexit__</span><span class="p">(</span><span class="n">exc_type</span><span class="p">,</span> <span class="n">exc</span><span class="p">,</span> <span class="n">traceback</span><span class="p">)</span>

<div class="viewcode-block" id="Router.bind"><a class="viewcode-back" href="../../api-reference/remote.html#runtime.log.Router.bind">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">bind</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="n">frontend</span><span class="p">:</span> <span class="n">Collection</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">backend</span><span class="p">:</span> <span class="n">Collection</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">frontend_options</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">SocketOptions</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">backend_options</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">SocketOptions</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;Router&#39;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Construct a :class:`Router` bound to the provided addresses.&quot;&quot;&quot;</span>
        <span class="c1"># pylint: disable=unexpected-keyword-arg; dataclass not recognized</span>
        <span class="n">frontend_options</span> <span class="o">=</span> <span class="n">frontend_options</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="n">backend_options</span> <span class="o">=</span> <span class="n">backend_options</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="n">frontend_options</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">zmq</span><span class="o">.</span><span class="n">IDENTITY</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;router-frontend&#39;</span><span class="p">)</span>
        <span class="n">backend_options</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">zmq</span><span class="o">.</span><span class="n">IDENTITY</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;router-backend&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Router</span><span class="p">(</span>
            <span class="n">SocketNode</span><span class="p">(</span>
                <span class="n">socket_type</span><span class="o">=</span><span class="n">zmq</span><span class="o">.</span><span class="n">ROUTER</span><span class="p">,</span>
                <span class="n">bindings</span><span class="o">=</span><span class="nb">frozenset</span><span class="p">(</span><span class="n">frontend</span><span class="p">),</span>
                <span class="n">options</span><span class="o">=</span><span class="n">frontend_options</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="n">SocketNode</span><span class="p">(</span>
                <span class="n">socket_type</span><span class="o">=</span><span class="n">zmq</span><span class="o">.</span><span class="n">ROUTER</span><span class="p">,</span>
                <span class="n">bindings</span><span class="o">=</span><span class="nb">frozenset</span><span class="p">(</span><span class="n">backend</span><span class="p">),</span>
                <span class="n">options</span><span class="o">=</span><span class="n">backend_options</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span></div></div>
</pre></div>

          </div>
          <div class="page-nav">
            <div class="inner"><ul class="page-nav">
</ul><div class="footer" role="contentinfo">
      &#169; Copyright 2021, Pioneers in Engineering.
    <br>
    Created using <a href="http://sphinx-doc.org/">Sphinx</a> 4.2.0 with <a href="https://github.com/schettino72/sphinx_press_theme">Press Theme</a> 0.8.0.
</div>
            </div>
          </div>
      </page>
    </div></div>
    
    
  </body>
</html>