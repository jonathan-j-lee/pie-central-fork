<!DOCTYPE html>
<html >
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
      <title>runtime.buffer</title>
    
          <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
          <link rel="stylesheet" href="../../_static/theme.css " type="text/css" />
          <link rel="stylesheet" href="../../_static/css/custom.css" type="text/css" />
      
      <!-- sphinx script_files -->
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>

      
      <!-- bundled in js (rollup iife) -->
      <!-- <script src="../../_static/theme-vendors.js"></script> -->
      <script src="../../_static/theme.js" defer></script>
    
  <link rel="index" title="Index" href="../../genindex.html" />
  <link rel="search" title="Search" href="../../search.html" /> 
  </head>

  <body>
    <div id="app">
    <div class="theme-container" :class="pageClasses"><navbar @toggle-sidebar="toggleSidebar">
  <router-link to="../../index.html" class="home-link">
    
      <span class="site-name">Runtime</span>
    
  </router-link>

  <div class="links">
    <navlinks class="can-hide">



    </navlinks>
  </div>
</navbar>

      
      <div class="sidebar-mask" @click="toggleSidebar(false)">
      </div>
        <sidebar @toggle-sidebar="toggleSidebar">
          
          <navlinks>
            



            
          </navlinks><div id="searchbox" class="searchbox" role="search">
  <div class="caption"><span class="caption-text">Quick search</span>
    <div class="searchformwrapper">
      <form class="search" action="../../search.html" method="get">
        <input type="text" name="q" />
        <input type="submit" value="Search" />
        <input type="hidden" name="check_keywords" value="yes" />
        <input type="hidden" name="area" value="default" />
      </form>
    </div>
  </div>
</div><div class="sidebar-links" role="navigation" aria-label="main navigation">
  
    <div class="sidebar-group">
      <p class="caption">
        <span class="caption-text"><a href="../../index.html#runtime-documentation">Contents:</a></span>
      </p>
      <ul class="">
        
          <li class="toctree-l1 ">
            
              <a href="../../design.html" class="reference internal ">Design Goals</a>
            

            
          </li>

        
          <li class="toctree-l1 ">
            
              <a href="../../architecture.html" class="reference internal ">Architecture</a>
            

            
          </li>

        
          <li class="toctree-l1 ">
            
              <a href="../../ipc.html" class="reference internal ">IPC</a>
            

            
          </li>

        
          <li class="toctree-l1 ">
            
              <a href="../../smart-devices.html" class="reference internal ">Smart Devices</a>
            

            
          </li>

        
          <li class="toctree-l1 ">
            
              <a href="../../api-reference/index.html" class="reference internal ">API Reference</a>
            

            
          </li>

        
      </ul>
    </div>
  
</div>
        </sidebar>

      <page>
          <div class="body-header" role="navigation" aria-label="navigation">
  
  <ul class="breadcrumbs">
    <li><a href="../../index.html">Docs</a> &raquo;</li>
    
      <li><a href="../index.html">Module code</a> &raquo;</li>
    
    <li>runtime.buffer</li>
  </ul>
  

  <ul class="page-nav">
</ul>
  
</div>
<hr>
          <div class="content" role="main" v-pre>
            
  <h1>Source code for runtime.buffer</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Peripheral data storage and sharing.</span>

<span class="sd">Buffers are the primary interprocess communication (IPC) mechanism within Runtime. Each</span>
<span class="sd">buffer is a C-style structure created with the :mod:`ctypes` foreign function library</span>
<span class="sd">and possibly backed by shared memory. Each buffer represents one Smart Device or other</span>
<span class="sd">peripheral and contains parameters that can be read or written to.</span>

<span class="sd">For extensibility reasons, this library contains no hardcoded information about specific</span>
<span class="sd">peripherals. Instead, this library parses each peripheral&#39;s parameter and memory layout</span>
<span class="sd">specifications from a config file and generates the buffer types dynamically.</span>

<span class="sd">Consumers should poll buffers for changes. There is no mechanism for event-based</span>
<span class="sd">notifications.</span>

<span class="sd">This library is synchronous. Since many operations acquire a mutex, buffer operations</span>
<span class="sd">should run in an executor, so as not to block the event loop.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">collections.abc</span>
<span class="kn">import</span> <span class="nn">contextlib</span>
<span class="kn">import</span> <span class="nn">ctypes</span>
<span class="kn">import</span> <span class="nn">functools</span>
<span class="kn">import</span> <span class="nn">operator</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">types</span>
<span class="kn">import</span> <span class="nn">typing</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">field</span>
<span class="kn">from</span> <span class="nn">multiprocessing.shared_memory</span> <span class="kn">import</span> <span class="n">SharedMemory</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">Any</span><span class="p">,</span>
    <span class="n">Callable</span><span class="p">,</span>
    <span class="n">Collection</span><span class="p">,</span>
    <span class="n">ContextManager</span><span class="p">,</span>
    <span class="n">Iterator</span><span class="p">,</span>
    <span class="n">Mapping</span><span class="p">,</span>
    <span class="n">MutableMapping</span><span class="p">,</span>
    <span class="n">NamedTuple</span><span class="p">,</span>
    <span class="n">Optional</span><span class="p">,</span>
    <span class="n">TypeVar</span><span class="p">,</span>
    <span class="n">Union</span><span class="p">,</span>
<span class="p">)</span>

<span class="kn">from</span> <span class="nn">.exception</span> <span class="kn">import</span> <span class="n">RuntimeBaseException</span>
<span class="kn">from</span> <span class="nn">.messaging</span> <span class="kn">import</span> <span class="n">Message</span><span class="p">,</span> <span class="n">MessageError</span><span class="p">,</span> <span class="n">MessageType</span><span class="p">,</span> <span class="n">ParameterMap</span>
<span class="kn">from</span> <span class="nn">.sync</span> <span class="kn">import</span> <span class="n">Mutex</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;Buffer&#39;</span><span class="p">,</span>
    <span class="s1">&#39;BufferStore&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Catalog&#39;</span><span class="p">,</span>
    <span class="s1">&#39;DeviceBuffer&#39;</span><span class="p">,</span>
    <span class="s1">&#39;DeviceBufferError&#39;</span><span class="p">,</span>
    <span class="s1">&#39;DeviceUID&#39;</span><span class="p">,</span>
    <span class="s1">&#39;NullDevice&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Parameter&#39;</span><span class="p">,</span>
<span class="p">]</span>

<span class="c1"># List: https://docs.python.org/3/library/ctypes.html#fundamental-data-types</span>
<span class="n">_SIMPLE_TYPES</span><span class="p">:</span> <span class="nb">frozenset</span><span class="p">[</span><span class="nb">type</span><span class="p">]</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">(</span>
    <span class="p">{</span>
        <span class="n">ctypes</span><span class="o">.</span><span class="n">c_bool</span><span class="p">,</span>
        <span class="n">ctypes</span><span class="o">.</span><span class="n">c_char</span><span class="p">,</span>
        <span class="n">ctypes</span><span class="o">.</span><span class="n">c_wchar</span><span class="p">,</span>
        <span class="n">ctypes</span><span class="o">.</span><span class="n">c_ubyte</span><span class="p">,</span>
        <span class="n">ctypes</span><span class="o">.</span><span class="n">c_byte</span><span class="p">,</span>
        <span class="n">ctypes</span><span class="o">.</span><span class="n">c_short</span><span class="p">,</span>
        <span class="n">ctypes</span><span class="o">.</span><span class="n">c_ushort</span><span class="p">,</span>
        <span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="p">,</span>
        <span class="n">ctypes</span><span class="o">.</span><span class="n">c_uint</span><span class="p">,</span>
        <span class="n">ctypes</span><span class="o">.</span><span class="n">c_long</span><span class="p">,</span>
        <span class="n">ctypes</span><span class="o">.</span><span class="n">c_ulong</span><span class="p">,</span>
        <span class="n">ctypes</span><span class="o">.</span><span class="n">c_longlong</span><span class="p">,</span>
        <span class="n">ctypes</span><span class="o">.</span><span class="n">c_ulonglong</span><span class="p">,</span>
        <span class="n">ctypes</span><span class="o">.</span><span class="n">c_size_t</span><span class="p">,</span>
        <span class="n">ctypes</span><span class="o">.</span><span class="n">c_ssize_t</span><span class="p">,</span>
        <span class="n">ctypes</span><span class="o">.</span><span class="n">c_float</span><span class="p">,</span>
        <span class="n">ctypes</span><span class="o">.</span><span class="n">c_double</span><span class="p">,</span>
        <span class="n">ctypes</span><span class="o">.</span><span class="n">c_longdouble</span><span class="p">,</span>
        <span class="n">ctypes</span><span class="o">.</span><span class="n">c_char_p</span><span class="p">,</span>
        <span class="n">ctypes</span><span class="o">.</span><span class="n">c_wchar_p</span><span class="p">,</span>
        <span class="n">ctypes</span><span class="o">.</span><span class="n">c_void_p</span><span class="p">,</span>
    <span class="p">}</span>
<span class="p">)</span>


<div class="viewcode-block" id="DeviceBufferError"><a class="viewcode-back" href="../../api-reference/buffer.html#runtime.buffer.DeviceBufferError">[docs]</a><span class="k">class</span> <span class="nc">DeviceBufferError</span><span class="p">(</span><span class="n">RuntimeBaseException</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Error when interfacing with a buffer.&quot;&quot;&quot;</span></div>


<div class="viewcode-block" id="Parameter"><a class="viewcode-back" href="../../api-reference/buffer.html#runtime.buffer.Parameter">[docs]</a><span class="k">class</span> <span class="nc">Parameter</span><span class="p">(</span><span class="n">NamedTuple</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A parameter descriptor.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        name: The parameter name.</span>
<span class="sd">        ctype: A :mod:`ctypes` type.</span>
<span class="sd">        id: The parameter ID, a nonnegative integer.</span>
<span class="sd">        lower: This parameter&#39;s minimum valid value. For numeric parameters only.</span>
<span class="sd">        upper: This parameter&#39;s maximum valid value. For numeric parameters only.</span>
<span class="sd">        readable: Whether this parameter should be readable with :meth:`Buffer.get`.</span>
<span class="sd">        writeable: Whether this parameter should be writeable with :meth:`Buffer.write`.</span>
<span class="sd">        subscribed: Whether this parameter should be subscribed to, by default. Only</span>
<span class="sd">            applicable for Smart Devices.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">ctype</span><span class="p">:</span> <span class="nb">type</span>
    <span class="nb">id</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">lower</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;-inf&#39;</span><span class="p">)</span>
    <span class="n">upper</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>
    <span class="n">readable</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">writeable</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">subscribed</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">platform_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">/</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">type</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;A C type that has the correct width to hold this parameter&#39;s values.</span>

<span class="sd">        The type widths of Runtime&#39;s platform and the peripheral&#39;s platform may not</span>
<span class="sd">        match. This method performs the necessary conversion to allocate the correct</span>
<span class="sd">        amount of buffer space.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A type exactly as wide as the values (bytes) emitted by the peripheral.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_float</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ctype</span> <span class="ow">is</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_double</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">ctype</span>

<div class="viewcode-block" id="Parameter.parse_ctype"><a class="viewcode-back" href="../../api-reference/buffer.html#runtime.buffer.Parameter.parse_ctype">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">parse_ctype</span><span class="p">(</span><span class="n">type_specifier</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">type</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Parse a type specifier into the corresponding C type.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            type_specifier: A description of the parameter&#39;s type. Can be a the name of</span>
<span class="sd">                any simple :mod:`ctypes` data type without the ``c_`` prefix. A vector</span>
<span class="sd">                type of `n` elements can also be specified by appending ``[&lt;n&gt;]`` to an</span>
<span class="sd">                existing type (resembling C array declaration syntax). Pointer types are</span>
<span class="sd">                not supported.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A :mod:`ctypes`-compatible data type.</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; assert Parameter.parse_ctype(&#39;bool&#39;) is ctypes.c_bool</span>
<span class="sd">            &gt;&gt;&gt; assert Parameter.parse_ctype(&#39;int32[64]&#39;) is ctypes.c_int32 * 64</span>
<span class="sd">            &gt;&gt;&gt; assert Parameter.parse_ctype(&#39;uint64[8][8]&#39;) is ctypes.c_uint64 * 8 * 8</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pattern</span><span class="p">,</span> <span class="n">dimensions</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(\[(\d+)\])$&#39;</span><span class="p">),</span> <span class="p">[]</span>
        <span class="k">while</span> <span class="n">match</span> <span class="o">:=</span> <span class="n">pattern</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">type_specifier</span><span class="p">):</span>
            <span class="n">suffix</span><span class="p">,</span> <span class="n">dimension</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">groups</span><span class="p">()</span>
            <span class="n">type_specifier</span> <span class="o">=</span> <span class="n">type_specifier</span><span class="o">.</span><span class="n">removesuffix</span><span class="p">(</span><span class="n">suffix</span><span class="p">)</span>
            <span class="n">dimensions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">dimension</span><span class="p">))</span>
        <span class="n">ctype</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">ctypes</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;c_</span><span class="si">{</span><span class="n">type_specifier</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="n">dimensions</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">ctype</span> <span class="o">*=</span> <span class="n">dim</span>
        <span class="k">return</span> <span class="n">typing</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="nb">type</span><span class="p">,</span> <span class="n">ctype</span><span class="p">)</span></div>

<div class="viewcode-block" id="Parameter.clamp"><a class="viewcode-back" href="../../api-reference/buffer.html#runtime.buffer.Parameter.clamp">[docs]</a>    <span class="k">def</span> <span class="nf">clamp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="o">/</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Ensure a real value is between this parameter&#39;s lower and upper limits.</span>

<span class="sd">        If the value is not within the bounds, this method will emit a warning.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            value: Candidate value.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A value between :attr:`Parameter.lower` and :attr:`Parameter.upper`. A value</span>
<span class="sd">            that exceeds the minimum or maximum will be clipped to that bound.</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; param = Parameter(&#39;param&#39;, ctypes.c_double, 0, lower=-1, upper=1)</span>
<span class="sd">            &gt;&gt;&gt; param.clamp(-1.1)</span>
<span class="sd">            -1</span>
<span class="sd">            &gt;&gt;&gt; param.clamp(1.1)</span>
<span class="sd">            1</span>
<span class="sd">            &gt;&gt;&gt; param.clamp(0)</span>
<span class="sd">            0</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">value</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">lower</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1"> exceeded lowerbound (</span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s1"> &lt; </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">lower</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">value</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">upper</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1"> exceeded upperbound (</span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s1"> &gt; </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">upper</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lower</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">upper</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">default</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">/</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;The default value when initializing this parameter.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The default value of :attr:`Parameter.platform_type`.</span>

<span class="sd">        Raises:</span>
<span class="sd">            DeviceBufferError: If this parameter is not a simple :mod:`ctype`.</span>

<span class="sd">        Example:</span>
<span class="sd">            &gt;&gt;&gt; Parameter(&#39;param&#39;, ctypes.c_double, 0).default</span>
<span class="sd">            0.0</span>
<span class="sd">            &gt;&gt;&gt; Parameter(&#39;param&#39;, ctypes.c_int8, 0).default</span>
<span class="sd">            0</span>
<span class="sd">            &gt;&gt;&gt; Parameter(&#39;param&#39;, ctypes.c_bool, 0).default</span>
<span class="sd">            False</span>
<span class="sd">            &gt;&gt;&gt; Parameter(&#39;param&#39;, ctypes.c_bool * 3, 0).default</span>
<span class="sd">            Traceback (most recent call last):</span>
<span class="sd">              ...</span>
<span class="sd">            runtime.buffer.DeviceBufferError: vector parameters have no default</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ctype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">platform_type</span>
        <span class="k">if</span> <span class="n">ctype</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_SIMPLE_TYPES</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">DeviceBufferError</span><span class="p">(</span>
                <span class="s1">&#39;vector parameters have no default&#39;</span><span class="p">,</span>
                <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">ctype</span><span class="p">()</span><span class="o">.</span><span class="n">value</span></div>


<span class="n">WriteableBuffer</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s1">&#39;WriteableBuffer&#39;</span><span class="p">,</span> <span class="nb">memoryview</span><span class="p">,</span> <span class="nb">bytearray</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">BaseStructure</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">LittleEndianStructure</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Base type for all structures.</span>

<span class="sd">    This type ensures all buffers have the same endianness. The endianness of this type</span>
<span class="sd">    should match that of the Smart Device platform.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_view</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">/</span><span class="p">,</span> <span class="n">base</span><span class="p">:</span> <span class="n">WriteableBuffer</span><span class="p">,</span> <span class="n">field_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">memoryview</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get a memory view of a field from the structure&#39;s buffer.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            base: The buffer backing the structure.</span>
<span class="sd">            field_name: The name of the field view to extract.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">field_desc</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">field_name</span><span class="p">)</span>
        <span class="n">view</span> <span class="o">=</span> <span class="nb">memoryview</span><span class="p">(</span><span class="n">base</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">view</span><span class="p">[</span><span class="n">field_desc</span><span class="o">.</span><span class="n">offset</span> <span class="p">:</span> <span class="n">field_desc</span><span class="o">.</span><span class="n">offset</span> <span class="o">+</span> <span class="n">field_desc</span><span class="o">.</span><span class="n">size</span><span class="p">]</span>


<span class="nd">@functools</span><span class="o">.</span><span class="n">lru_cache</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="mi">64</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">make_bitmask</span><span class="p">(</span><span class="n">bits</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Construct a bitmask with the specified bitlength.</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; make_bitmask(0)</span>
<span class="sd">        Traceback (most recent call last):</span>
<span class="sd">          ...</span>
<span class="sd">        ValueError: must provide a positive number of bits</span>
<span class="sd">        &gt;&gt;&gt; bin(make_bitmask(1))</span>
<span class="sd">        &#39;0b1&#39;</span>
<span class="sd">        &gt;&gt;&gt; bin(make_bitmask(5))</span>
<span class="sd">        &#39;0b11111&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">bits</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;must provide a positive number of bits&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">bits</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>


<div class="viewcode-block" id="DeviceUID"><a class="viewcode-back" href="../../api-reference/buffer.html#runtime.buffer.DeviceUID">[docs]</a><span class="k">class</span> <span class="nc">DeviceUID</span><span class="p">(</span><span class="n">BaseStructure</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A unique device identifier.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        device_id (int): The device&#39;s type ID. Consult the catalog for the full list.</span>
<span class="sd">        year (int): The year in which the device was created. ``0x00`` corresponds to</span>
<span class="sd">            the spring 2016 season, and increments for each season afterwards.</span>
<span class="sd">        random (int): The UID&#39;s random bits to distinguish otherwise identical devices.</span>

<span class="sd">    Examples:</span>
<span class="sd">        &gt;&gt;&gt; uid = DeviceUID(0xffff, 0xee, 0xc0debeef_deadbeef)</span>
<span class="sd">        &gt;&gt;&gt; assert int(uid) == 0xffff_ee_c0debeef_deadbeef</span>
<span class="sd">        &gt;&gt;&gt; uid = DeviceUID.from_int(0xffff_ee_c0debeef_deadbeef)</span>
<span class="sd">        &gt;&gt;&gt; hex(uid.device_id)</span>
<span class="sd">        &#39;0xffff&#39;</span>
<span class="sd">        &gt;&gt;&gt; hex(uid.year)</span>
<span class="sd">        &#39;0xee&#39;</span>
<span class="sd">        &gt;&gt;&gt; hex(uid.random)</span>
<span class="sd">        &#39;0xc0debeefdeadbeef&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_fields_</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="s1">&#39;device_id&#39;</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_uint16</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;year&#39;</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_uint8</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;random&#39;</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_uint64</span><span class="p">),</span>
    <span class="p">]</span>

    <span class="k">def</span> <span class="fm">__int__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">/</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="n">uid</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device_id</span><span class="p">)</span>
        <span class="n">uid</span> <span class="o">=</span> <span class="p">(</span><span class="n">uid</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">*</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">year</span><span class="o">.</span><span class="n">size</span><span class="p">)</span> <span class="o">|</span> <span class="bp">self</span><span class="o">.</span><span class="n">year</span>
        <span class="n">uid</span> <span class="o">=</span> <span class="p">(</span><span class="n">uid</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">*</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">size</span><span class="p">)</span> <span class="o">|</span> <span class="bp">self</span><span class="o">.</span><span class="n">random</span>
        <span class="k">return</span> <span class="n">uid</span>

<div class="viewcode-block" id="DeviceUID.from_int"><a class="viewcode-back" href="../../api-reference/buffer.html#runtime.buffer.DeviceUID.from_int">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_int</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">/</span><span class="p">,</span> <span class="n">uid</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;DeviceUID&#39;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Parse a device UID in integer format into its constituent fields.&quot;&quot;&quot;</span>
        <span class="n">rand</span><span class="p">,</span> <span class="n">uid</span> <span class="o">=</span> <span class="n">uid</span> <span class="o">&amp;</span> <span class="n">make_bitmask</span><span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="bp">cls</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">size</span><span class="p">),</span> <span class="n">uid</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span> <span class="o">*</span> <span class="bp">cls</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">size</span>
        <span class="n">year</span><span class="p">,</span> <span class="n">uid</span> <span class="o">=</span> <span class="n">uid</span> <span class="o">&amp;</span> <span class="n">make_bitmask</span><span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="bp">cls</span><span class="o">.</span><span class="n">year</span><span class="o">.</span><span class="n">size</span><span class="p">),</span> <span class="n">uid</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span> <span class="o">*</span> <span class="bp">cls</span><span class="o">.</span><span class="n">year</span><span class="o">.</span><span class="n">size</span>
        <span class="n">device_id</span> <span class="o">=</span> <span class="n">uid</span> <span class="o">&amp;</span> <span class="n">make_bitmask</span><span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="bp">cls</span><span class="o">.</span><span class="n">device_id</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">DeviceUID</span><span class="p">(</span><span class="n">device_id</span><span class="p">,</span> <span class="n">year</span><span class="p">,</span> <span class="n">rand</span><span class="p">)</span></div></div>


<span class="k">class</span> <span class="nc">DeviceMetricsBlock</span><span class="p">(</span><span class="n">BaseStructure</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A special structure for storing Smart Device statistics.&quot;&quot;&quot;</span>

    <span class="n">_counter_type</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_uint64</span>
    <span class="n">_fields_</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="s1">&#39;send&#39;</span><span class="p">,</span> <span class="n">_counter_type</span> <span class="o">*</span> <span class="n">Message</span><span class="o">.</span><span class="n">MAX_PARAMS</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;recv&#39;</span><span class="p">,</span> <span class="n">_counter_type</span> <span class="o">*</span> <span class="n">Message</span><span class="o">.</span><span class="n">MAX_PARAMS</span><span class="p">),</span>
    <span class="p">]</span>


<span class="k">class</span> <span class="nc">DeviceControlBlock</span><span class="p">(</span><span class="n">BaseStructure</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A special structure for bookkeeping Smart Device control state.&quot;&quot;&quot;</span>

    <span class="n">_param_map_type</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_uint16</span>
    <span class="n">_timestamp_type</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_double</span>
    <span class="n">_fields_</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="s1">&#39;uid&#39;</span><span class="p">,</span> <span class="n">DeviceUID</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;subscription&#39;</span><span class="p">,</span> <span class="n">_param_map_type</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;interval&#39;</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_uint16</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;read&#39;</span><span class="p">,</span> <span class="n">_param_map_type</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;write&#39;</span><span class="p">,</span> <span class="n">_param_map_type</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;update&#39;</span><span class="p">,</span> <span class="n">_param_map_type</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;last_write&#39;</span><span class="p">,</span> <span class="n">_timestamp_type</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;last_update&#39;</span><span class="p">,</span> <span class="n">_timestamp_type</span><span class="p">),</span>
    <span class="p">]</span>
    <span class="n">interval_spec</span><span class="p">:</span> <span class="n">Parameter</span> <span class="o">=</span> <span class="n">Parameter</span><span class="p">(</span><span class="s1">&#39;interval&#39;</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_uint16</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">250</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">ParameterBlock</span><span class="p">(</span><span class="n">BaseStructure</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A structure for holding parameters.&quot;&quot;&quot;</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">make_type</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">/</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">params</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Parameter</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">type</span><span class="p">[</span><span class="s1">&#39;ParameterBlock&#39;</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Make a structure with the given parameters as fields.&quot;&quot;&quot;</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="p">[(</span><span class="n">param</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">param</span><span class="o">.</span><span class="n">platform_type</span><span class="p">)</span> <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">params</span><span class="p">]</span>
        <span class="k">return</span> <span class="nb">type</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="bp">cls</span><span class="p">,),</span> <span class="p">{</span><span class="s1">&#39;_fields_&#39;</span><span class="p">:</span> <span class="n">fields</span><span class="p">,</span> <span class="s1">&#39;params&#39;</span><span class="p">:</span> <span class="n">params</span><span class="p">})</span>


<span class="n">RT</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s1">&#39;RT&#39;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">with_transaction</span><span class="p">(</span><span class="n">wrapped</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">RT</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">RT</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;Decorator applied to :class:`Buffer` methods to begin a transaction.&quot;&quot;&quot;</span>

    <span class="nd">@functools</span><span class="o">.</span><span class="n">wraps</span><span class="p">(</span><span class="n">wrapped</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="s1">&#39;Buffer&#39;</span><span class="p">,</span> <span class="o">/</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RT</span><span class="p">:</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">transaction</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">wrapped</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">wrapper</span>


<span class="n">BufferType</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s1">&#39;BufferType&#39;</span><span class="p">,</span> <span class="n">bound</span><span class="o">=</span><span class="s1">&#39;Buffer&#39;</span><span class="p">)</span>
<span class="n">DeviceBufferType</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s1">&#39;DeviceBufferType&#39;</span><span class="p">,</span> <span class="n">bound</span><span class="o">=</span><span class="s1">&#39;DeviceBuffer&#39;</span><span class="p">)</span>


<div class="viewcode-block" id="Buffer"><a class="viewcode-back" href="../../api-reference/buffer.html#runtime.buffer.Buffer">[docs]</a><span class="k">class</span> <span class="nc">Buffer</span><span class="p">(</span><span class="n">BaseStructure</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A structure for storing peripheral data.</span>

<span class="sd">    A buffer consists of two substructures: an *update block* for storing current</span>
<span class="sd">    parameter values (as read from the peripheral), and a *write block* for parameter</span>
<span class="sd">    values to be written to the peripheral.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        params: Maps param names to their descriptors.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">params</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Parameter</span><span class="p">]</span>
    <span class="n">mutex</span><span class="p">:</span> <span class="n">ContextManager</span><span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">nullcontext</span><span class="p">()</span>

<div class="viewcode-block" id="Buffer.attach"><a class="viewcode-back" href="../../api-reference/buffer.html#runtime.buffer.Buffer.attach">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">attach</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">:</span> <span class="nb">type</span><span class="p">[</span><span class="n">BufferType</span><span class="p">],</span>
        <span class="n">buf</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">WriteableBuffer</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">/</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BufferType</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Create a new buffer.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            buf: A writeable Python buffer (not to be confused with :class:`Buffer`). If</span>
<span class="sd">                not provided, a :class:`bytearray` with the correct size is allocated.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">buf</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="nb">bytearray</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">sizeof</span><span class="p">(</span><span class="bp">cls</span><span class="p">)))</span>
        <span class="n">structure</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">from_buffer</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span>
        <span class="n">structure</span><span class="o">.</span><span class="n">buf</span> <span class="o">=</span> <span class="n">buf</span>
        <span class="k">return</span> <span class="n">structure</span></div>

<div class="viewcode-block" id="Buffer.make_type"><a class="viewcode-back" href="../../api-reference/buffer.html#runtime.buffer.Buffer.make_type">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">make_type</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">:</span> <span class="nb">type</span><span class="p">[</span><span class="n">BufferType</span><span class="p">],</span>
        <span class="o">/</span><span class="p">,</span>
        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">params</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Parameter</span><span class="p">],</span>
        <span class="o">*</span><span class="n">extra_fields</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">type</span><span class="p">],</span>
        <span class="o">**</span><span class="n">attrs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">type</span><span class="p">[</span><span class="n">BufferType</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Create a new buffer type (subclass).</span>

<span class="sd">        Parameters:</span>
<span class="sd">            name: Type name prefix (preferably kebab case).</span>
<span class="sd">            params: Parameter list.</span>
<span class="sd">            extra_fields: Extra :mod:`ctypes` fields (name and types).</span>
<span class="sd">            attrs: Additional class attributes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">normalized_name</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">title</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">update_block_type</span> <span class="o">=</span> <span class="n">ParameterBlock</span><span class="o">.</span><span class="n">make_type</span><span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">normalized_name</span><span class="si">}</span><span class="s1">UpdateBlock&#39;</span><span class="p">,</span>
            <span class="p">[</span><span class="n">param</span> <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">params</span> <span class="k">if</span> <span class="n">param</span><span class="o">.</span><span class="n">readable</span><span class="p">],</span>
        <span class="p">)</span>
        <span class="n">write_block_type</span> <span class="o">=</span> <span class="n">ParameterBlock</span><span class="o">.</span><span class="n">make_type</span><span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">normalized_name</span><span class="si">}</span><span class="s1">WriteBlock&#39;</span><span class="p">,</span>
            <span class="p">[</span><span class="n">param</span> <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">params</span> <span class="k">if</span> <span class="n">param</span><span class="o">.</span><span class="n">writeable</span><span class="p">],</span>
        <span class="p">)</span>
        <span class="n">attrs</span> <span class="o">|=</span> <span class="p">{</span>
            <span class="s1">&#39;_fields_&#39;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">(</span><span class="s1">&#39;valid_flag&#39;</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_bool</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;update_block&#39;</span><span class="p">,</span> <span class="n">update_block_type</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;write_block&#39;</span><span class="p">,</span> <span class="n">write_block_type</span><span class="p">),</span>
                <span class="o">*</span><span class="n">extra_fields</span><span class="p">,</span>
            <span class="p">],</span>
            <span class="s1">&#39;params&#39;</span><span class="p">:</span> <span class="p">{</span><span class="n">param</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">param</span> <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">params</span><span class="p">},</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nb">type</span><span class="p">(</span><span class="n">normalized_name</span><span class="p">,</span> <span class="p">(</span><span class="bp">cls</span><span class="p">,),</span> <span class="n">attrs</span><span class="p">)</span></div>

<div class="viewcode-block" id="Buffer.open"><a class="viewcode-back" href="../../api-reference/buffer.html#runtime.buffer.Buffer.open">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="nd">@contextlib</span><span class="o">.</span><span class="n">contextmanager</span>
    <span class="k">def</span> <span class="nf">open</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">/</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">create</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="s1">&#39;Buffer&#39;</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Open a new buffer backed by shared memory.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            name: The shared memory object&#39;s name.</span>
<span class="sd">            create: Whether to attempt to create a new shared memory object. If ``True``</span>
<span class="sd">                but the object already exists, :meth:`open` silently attaches to the</span>
<span class="sd">                existing object.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A context manager that automatically closes the shared memory object when</span>
<span class="sd">            the exit handler runs. The object is *not* unlinked, meaning other processes</span>
<span class="sd">            may still access the object. To finally destroy the object, you must call</span>
<span class="sd">            :meth:`Buffer.unlink` on this object&#39;s name.</span>

<span class="sd">        Raises:</span>
<span class="sd">            DeviceBufferError: If ``create=False``, but the object does not exist.</span>

<span class="sd">        Note:</span>
<span class="sd">            When two processes attempt to create this buffer simultaneously, there is a</span>
<span class="sd">            small chance that the buffer that loses out yields its view before the other</span>
<span class="sd">            process initializes the mutex. This behavior is OK, since attempting to</span>
<span class="sd">            acquire an uninitialized mutex should raise a ``SyncError`` with EINVAL.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">size</span> <span class="o">=</span> <span class="n">Mutex</span><span class="o">.</span><span class="n">SIZE</span> <span class="o">+</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">sizeof</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">shm</span><span class="p">,</span> <span class="n">create_success</span> <span class="o">=</span> <span class="n">SharedMemory</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">create</span><span class="o">=</span><span class="n">create</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">),</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="ne">FileNotFoundError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">DeviceBufferError</span><span class="p">(</span>
                <span class="s1">&#39;cannot attach to nonexistent shared memory&#39;</span><span class="p">,</span>
                <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                <span class="n">create</span><span class="o">=</span><span class="n">create</span><span class="p">,</span>
                <span class="nb">type</span><span class="o">=</span><span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
            <span class="p">)</span> <span class="kn">from</span> <span class="nn">exc</span>
        <span class="k">except</span> <span class="ne">FileExistsError</span><span class="p">:</span>
            <span class="n">shm</span><span class="p">,</span> <span class="n">create_success</span> <span class="o">=</span> <span class="n">SharedMemory</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="kc">False</span>
        <span class="n">buffer</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">shm</span><span class="o">.</span><span class="n">buf</span><span class="p">[</span><span class="n">Mutex</span><span class="o">.</span><span class="n">SIZE</span> <span class="p">:])</span>
        <span class="n">mutex</span> <span class="o">=</span> <span class="n">Mutex</span><span class="p">(</span><span class="n">shm</span><span class="o">.</span><span class="n">buf</span><span class="p">[:</span> <span class="n">Mutex</span><span class="o">.</span><span class="n">SIZE</span><span class="p">],</span> <span class="n">shared</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">create_success</span><span class="p">:</span>
            <span class="n">mutex</span><span class="o">.</span><span class="n">initialize</span><span class="p">()</span>
        <span class="n">buffer</span><span class="o">.</span><span class="n">mutex</span> <span class="o">=</span> <span class="n">mutex</span>
        <span class="k">if</span> <span class="n">create</span><span class="p">:</span>
            <span class="n">buffer</span><span class="o">.</span><span class="n">valid</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">buffer</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">create</span><span class="p">:</span>
                <span class="n">buffer</span><span class="o">.</span><span class="n">valid</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">buffer</span><span class="o">.</span><span class="n">buf</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
            <span class="c1"># pylint: disable=protected-access; no good alternative solution</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">buffer</span><span class="o">.</span><span class="n">_objects</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>  <span class="c1"># pragma: no cover</span>
                <span class="n">buffer</span><span class="o">.</span><span class="n">_objects</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
            <span class="n">shm</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<div class="viewcode-block" id="Buffer.unlink"><a class="viewcode-back" href="../../api-reference/buffer.html#runtime.buffer.Buffer.unlink">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">unlink</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Destroy a shared memory object.</span>

<span class="sd">        The exact behavior depends on the platform. See :meth:`SharedMemory.unlink`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">suppress</span><span class="p">(</span><span class="ne">FileNotFoundError</span><span class="p">):</span>
            <span class="n">shm</span> <span class="o">=</span> <span class="n">SharedMemory</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="n">shm</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
            <span class="n">shm</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<div class="viewcode-block" id="Buffer.transaction"><a class="viewcode-back" href="../../api-reference/buffer.html#runtime.buffer.Buffer.transaction">[docs]</a>    <span class="nd">@contextlib</span><span class="o">.</span><span class="n">contextmanager</span>
    <span class="k">def</span> <span class="nf">transaction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">/</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="kc">None</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Acquire the buffer&#39;s mutex and check its valid bit.</span>

<span class="sd">        All methods already use this reentrant context manager to guarantee consistency,</span>
<span class="sd">        but this context manager may also be used to group transactions into a larger</span>
<span class="sd">        atomic transaction. This avoids acquiring and releasing the mutex repeatedly.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">mutex</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">valid_flag</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">DeviceBufferError</span><span class="p">(</span><span class="s1">&#39;device does not exist (marked as invalid)&#39;</span><span class="p">)</span>
            <span class="k">yield</span></div>

<div class="viewcode-block" id="Buffer.get"><a class="viewcode-back" href="../../api-reference/buffer.html#runtime.buffer.Buffer.get">[docs]</a>    <span class="nd">@with_transaction</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">param</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">/</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Read a parameter from the update block.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            param: The parameter name.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The parameter value. Consult the catalog for each device&#39;s parameters and</span>
<span class="sd">            their types.</span>

<span class="sd">        Raises:</span>
<span class="sd">            DeviceBufferError: If the parameter does not exist or is not readable.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">update_block</span><span class="p">,</span> <span class="n">param</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">DeviceBufferError</span><span class="p">(</span>
                <span class="s1">&#39;parameter does not exist or is not readable&#39;</span><span class="p">,</span>
                <span class="n">param</span><span class="o">=</span><span class="n">param</span><span class="p">,</span>
            <span class="p">)</span> <span class="kn">from</span> <span class="nn">exc</span></div>

<div class="viewcode-block" id="Buffer.set"><a class="viewcode-back" href="../../api-reference/buffer.html#runtime.buffer.Buffer.set">[docs]</a>    <span class="nd">@with_transaction</span>
    <span class="k">def</span> <span class="nf">set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">param</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="o">/</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Set a parameter value in the update block.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            param: The parameter name.</span>
<span class="sd">            value: The parameter value. Consult the catalog for each device&#39;s parameters</span>
<span class="sd">                and their types.</span>

<span class="sd">        Raises:</span>
<span class="sd">            DeviceBufferError: If the parameter does not exist or is not writeable.</span>
<span class="sd">            TypeError: If the value is not the correct type.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">update_block</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span></div>

<div class="viewcode-block" id="Buffer.write"><a class="viewcode-back" href="../../api-reference/buffer.html#runtime.buffer.Buffer.write">[docs]</a>    <span class="nd">@with_transaction</span>
    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">param</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="o">/</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Request writing a parameter to the device.</span>

<span class="sd">        Because the buffer is polled and the writes are batched during each cycle, it&#39;s</span>
<span class="sd">        possible to overwrite a pending parameter write. This is a feature to reduce</span>
<span class="sd">        excessive writes.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            param: The parameter name.</span>
<span class="sd">            value: The parameter value. Consult the catalog for each device&#39;s parameters</span>
<span class="sd">                and their types.</span>

<span class="sd">        Raises:</span>
<span class="sd">            DeviceBufferError: If the parameter does not exist or is not writeable.</span>
<span class="sd">            TypeError: If the value is not the correct type.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">write_block</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">block</span><span class="p">:</span> <span class="n">ParameterBlock</span><span class="p">,</span> <span class="n">param_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="o">/</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">block</span><span class="p">,</span> <span class="n">param_name</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">DeviceBufferError</span><span class="p">(</span>
                <span class="s1">&#39;parameter does not exist or is not writeable&#39;</span><span class="p">,</span>
                <span class="n">param</span><span class="o">=</span><span class="n">param_name</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="n">param</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">param_name</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">param</span><span class="o">.</span><span class="n">platform_type</span> <span class="ow">in</span> <span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_float</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_double</span><span class="p">):</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">param</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">block</span><span class="p">,</span> <span class="n">param_name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">valid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">/</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Whether this buffer represents an active device.&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">mutex</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">valid_flag</span>

    <span class="nd">@valid</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">valid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flag</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="o">/</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">mutex</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">valid_flag</span> <span class="o">=</span> <span class="n">flag</span></div>


<div class="viewcode-block" id="DeviceBuffer"><a class="viewcode-back" href="../../api-reference/buffer.html#runtime.buffer.DeviceBuffer">[docs]</a><span class="k">class</span> <span class="nc">DeviceBuffer</span><span class="p">(</span><span class="n">Buffer</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A special buffer representing a Smart Device.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        sub_interval: The default subscription interval in seconds.</span>
<span class="sd">        write_interval: The duration in seconds between device writes.</span>
<span class="sd">        heartbeat_interval: The duration in seconds between heartbeat requests.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">sub_interval</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.04</span>
    <span class="n">write_interval</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.04</span>
    <span class="n">heartbeat_interval</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_make_param_map</span><span class="p">(</span><span class="n">block</span><span class="p">:</span> <span class="n">ParameterBlock</span><span class="p">,</span> <span class="o">/</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ParameterMap</span><span class="p">:</span>
        <span class="n">param_map</span> <span class="o">=</span> <span class="n">ParameterMap</span><span class="p">()</span>
        <span class="n">base</span><span class="p">,</span> <span class="n">block_type</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">addressof</span><span class="p">(</span><span class="n">block</span><span class="p">),</span> <span class="nb">type</span><span class="p">(</span><span class="n">block</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">block</span><span class="o">.</span><span class="n">params</span><span class="p">:</span>
            <span class="n">struct_field</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">block_type</span><span class="p">,</span> <span class="n">param</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">struct_field</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># pragma: no cover; should always exist</span>
                <span class="n">offset</span> <span class="o">=</span> <span class="n">base</span> <span class="o">+</span> <span class="n">struct_field</span><span class="o">.</span><span class="n">offset</span>
                <span class="n">param_map</span><span class="o">.</span><span class="n">set_param</span><span class="p">(</span><span class="n">param</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">struct_field</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">param_map</span>

    <span class="nd">@functools</span><span class="o">.</span><span class="n">cached_property</span>
    <span class="k">def</span> <span class="nf">_update_param_map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">/</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ParameterMap</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_param_map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">update_block</span><span class="p">)</span>

    <span class="nd">@functools</span><span class="o">.</span><span class="n">cached_property</span>
    <span class="k">def</span> <span class="nf">_write_param_map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">/</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ParameterMap</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_param_map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">write_block</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">make_type</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">:</span> <span class="nb">type</span><span class="p">[</span><span class="n">DeviceBufferType</span><span class="p">],</span>
        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">params</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Parameter</span><span class="p">],</span>
        <span class="o">*</span><span class="n">extra_fields</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">type</span><span class="p">],</span>
        <span class="o">**</span><span class="n">attrs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">type</span><span class="p">[</span><span class="n">DeviceBufferType</span><span class="p">]:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">Message</span><span class="o">.</span><span class="n">MAX_PARAMS</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;Smart Devices may only have up to </span><span class="si">{</span><span class="n">Message</span><span class="o">.</span><span class="n">MAX_PARAMS</span><span class="si">}</span><span class="s1"> params&#39;</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">make_type</span><span class="p">(</span>
            <span class="n">name</span><span class="p">,</span>
            <span class="n">params</span><span class="p">,</span>
            <span class="p">(</span><span class="s1">&#39;control&#39;</span><span class="p">,</span> <span class="n">DeviceControlBlock</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;metrics&#39;</span><span class="p">,</span> <span class="n">DeviceMetricsBlock</span><span class="p">),</span>
            <span class="o">*</span><span class="n">extra_fields</span><span class="p">,</span>
            <span class="o">**</span><span class="n">attrs</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_from_bitmap</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">bitmap</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="o">/</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">frozenset</span><span class="p">[</span><span class="n">Parameter</span><span class="p">]:</span>
        <span class="n">params</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
        <span class="k">return</span> <span class="nb">frozenset</span><span class="p">(</span><span class="n">param</span> <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">params</span> <span class="k">if</span> <span class="p">(</span><span class="n">bitmap</span> <span class="o">&gt;&gt;</span> <span class="n">param</span><span class="o">.</span><span class="n">id</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mb">0b1</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_to_bitmap</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">params</span><span class="p">:</span> <span class="n">Collection</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="o">/</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="n">masks</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="bp">cls</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">param</span><span class="p">]</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">params</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">functools</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">operator</span><span class="o">.</span><span class="n">or_</span><span class="p">,</span> <span class="n">masks</span><span class="p">,</span> <span class="n">Message</span><span class="o">.</span><span class="n">NO_PARAMS</span><span class="p">)</span>

    <span class="nd">@functools</span><span class="o">.</span><span class="n">cached_property</span>
    <span class="k">def</span> <span class="nf">_read_mask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">/</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_to_bitmap</span><span class="p">([</span><span class="n">param</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">params</span> <span class="k">if</span> <span class="n">param</span><span class="o">.</span><span class="n">readable</span><span class="p">])</span>

    <span class="nd">@with_transaction</span>
    <span class="k">def</span> <span class="nf">set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">param</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="o">/</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">update</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">param</span><span class="p">]</span><span class="o">.</span><span class="n">id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">last_update</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="nd">@with_transaction</span>
    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">param</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="o">/</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">write</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">param</span><span class="p">]</span><span class="o">.</span><span class="n">id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">last_write</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

<div class="viewcode-block" id="DeviceBuffer.read"><a class="viewcode-back" href="../../api-reference/buffer.html#runtime.buffer.DeviceBuffer.read">[docs]</a>    <span class="nd">@with_transaction</span>
    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">/</span><span class="p">,</span> <span class="n">params</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Collection</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Request the device to return values for some parameters.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            params: A list of parameter names to return values for. Passing ``None``</span>
<span class="sd">                specifies all parameters of this device type.</span>

<span class="sd">        Raises:</span>
<span class="sd">            KeyError: If an invalid parameter name is provided.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">params</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="n">param</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">if</span> <span class="n">param</span><span class="o">.</span><span class="n">readable</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">read</span> <span class="o">|=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_to_bitmap</span><span class="p">(</span><span class="n">params</span><span class="p">)</span> <span class="o">&amp;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_mask</span></div>

    <span class="k">def</span> <span class="nf">_emit</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">make_msg</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">int</span><span class="p">,</span> <span class="n">ParameterMap</span><span class="p">],</span> <span class="n">Message</span><span class="p">],</span>
        <span class="n">bitmap</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">param_map</span><span class="p">:</span> <span class="n">ParameterMap</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">Message</span><span class="p">]:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">make_msg</span><span class="p">(</span><span class="n">bitmap</span><span class="p">,</span> <span class="n">param_map</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">MessageError</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_from_bitmap</span><span class="p">(</span><span class="n">bitmap</span><span class="p">):</span>
                <span class="k">yield</span> <span class="n">make_msg</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">param</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">param_map</span><span class="p">)</span>

<div class="viewcode-block" id="DeviceBuffer.emit_dev_rw"><a class="viewcode-back" href="../../api-reference/buffer.html#runtime.buffer.DeviceBuffer.emit_dev_rw">[docs]</a>    <span class="nd">@with_transaction</span>
    <span class="k">def</span> <span class="nf">emit_dev_rw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">/</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">Message</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Make messages for reading and writing parameters.</span>

<span class="sd">        Calling this method will clear the pending parameter maps.</span>

<span class="sd">        Yields:</span>
<span class="sd">            runtime.messaging.Message: Zero or more messages, depending on how many</span>
<span class="sd">            parameters the consumer requested with :meth:`read` or :meth:`Buffer.write`.</span>
<span class="sd">            If no parameters have been requested, since the last read, this method may</span>
<span class="sd">            yield no messages.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">write</span><span class="p">:</span>
            <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">_emit</span><span class="p">(</span>
                <span class="n">Message</span><span class="o">.</span><span class="n">make_dev_write</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">write</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_write_param_map</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">read</span> <span class="o">&amp;=</span> <span class="n">Message</span><span class="o">.</span><span class="n">ALL_PARAMS</span> <span class="o">^</span> <span class="bp">self</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">write</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">write</span> <span class="o">=</span> <span class="n">Message</span><span class="o">.</span><span class="n">NO_PARAMS</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">read</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">Message</span><span class="o">.</span><span class="n">make_dev_read</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">read</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">Message</span><span class="o">.</span><span class="n">NO_PARAMS</span></div>

<div class="viewcode-block" id="DeviceBuffer.emit_dev_data"><a class="viewcode-back" href="../../api-reference/buffer.html#runtime.buffer.DeviceBuffer.emit_dev_data">[docs]</a>    <span class="nd">@with_transaction</span>
    <span class="k">def</span> <span class="nf">emit_dev_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">/</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">Message</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Make messages for containing device data for recently updated parameters.</span>

<span class="sd">        Calling this method will mark all parameters are not recently updated.</span>

<span class="sd">        Yields:</span>
<span class="sd">            runtime.messaging.Message: Zero or more messages containing device data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Subscribed parameters will be read soon anyway.</span>
        <span class="c1"># This optimization deduplicates updates.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">update</span> <span class="o">&amp;=</span> <span class="n">Message</span><span class="o">.</span><span class="n">ALL_PARAMS</span> <span class="o">^</span> <span class="bp">self</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">subscription</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">update</span><span class="p">:</span>
            <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">_emit</span><span class="p">(</span>
                <span class="n">Message</span><span class="o">.</span><span class="n">make_dev_data</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">update</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_update_param_map</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">update</span> <span class="o">=</span> <span class="n">Message</span><span class="o">.</span><span class="n">NO_PARAMS</span></div>

<div class="viewcode-block" id="DeviceBuffer.emit_subscription"><a class="viewcode-back" href="../../api-reference/buffer.html#runtime.buffer.DeviceBuffer.emit_subscription">[docs]</a>    <span class="nd">@with_transaction</span>
    <span class="k">def</span> <span class="nf">emit_subscription</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">/</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">Message</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Make messages containing device data for subscribed parameters.</span>

<span class="sd">        Yields:</span>
<span class="sd">            runtime.messaging.Message: Zero or more messages containing device data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">_emit</span><span class="p">(</span>
            <span class="n">Message</span><span class="o">.</span><span class="n">make_dev_data</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">subscription</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_update_param_map</span><span class="p">,</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="DeviceBuffer.make_sub_req"><a class="viewcode-back" href="../../api-reference/buffer.html#runtime.buffer.DeviceBuffer.make_sub_req">[docs]</a>    <span class="nd">@with_transaction</span>
    <span class="k">def</span> <span class="nf">make_sub_req</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="o">/</span><span class="p">,</span>
        <span class="n">params</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Collection</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">interval</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Message</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Make a subscription request for some parameters.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            params: A list of parameter names to subscribe to. Passing ``None``</span>
<span class="sd">                specifies all parameters of this device type.</span>
<span class="sd">            interval: The duration between updates in seconds.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The subscription request message.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">params</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">params</span> <span class="o">=</span> <span class="p">{</span><span class="n">param</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">if</span> <span class="n">param</span><span class="o">.</span><span class="n">subscribed</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">interval</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">interval</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sub_interval</span>
        <span class="k">return</span> <span class="n">Message</span><span class="o">.</span><span class="n">make_sub_req</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_to_bitmap</span><span class="p">(</span><span class="n">params</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="mi">1000</span> <span class="o">*</span> <span class="n">interval</span><span class="p">))</span></div>

<div class="viewcode-block" id="DeviceBuffer.make_sub_res"><a class="viewcode-back" href="../../api-reference/buffer.html#runtime.buffer.DeviceBuffer.make_sub_res">[docs]</a>    <span class="nd">@with_transaction</span>
    <span class="k">def</span> <span class="nf">make_sub_res</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">/</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Message</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Make a subscription response for the parameters subscribed to.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The subscription response message.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">Message</span><span class="o">.</span><span class="n">make_sub_res</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">subscription</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">interval</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">uid</span><span class="o">.</span><span class="n">device_id</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">uid</span><span class="o">.</span><span class="n">year</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">uid</span><span class="o">.</span><span class="n">random</span><span class="p">,</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="DeviceBuffer.get_read"><a class="viewcode-back" href="../../api-reference/buffer.html#runtime.buffer.DeviceBuffer.get_read">[docs]</a>    <span class="nd">@with_transaction</span>
    <span class="k">def</span> <span class="nf">get_read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">/</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">frozenset</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Get the parameters that are to be read.</span>

<span class="sd">        Calling this method will clear the pending read map.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A collection of parameter names.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">params</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">(</span><span class="n">param</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_from_bitmap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">read</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">Message</span><span class="o">.</span><span class="n">NO_PARAMS</span>
        <span class="k">return</span> <span class="n">params</span></div>

<div class="viewcode-block" id="DeviceBuffer.get_write"><a class="viewcode-back" href="../../api-reference/buffer.html#runtime.buffer.DeviceBuffer.get_write">[docs]</a>    <span class="nd">@with_transaction</span>
    <span class="k">def</span> <span class="nf">get_write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">/</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Get the parameters that were written.</span>

<span class="sd">        Calling this method will clear the pending write map.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A map of parameter names to their corresponding values.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_from_bitmap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">write</span><span class="p">)</span>
        <span class="n">params</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">(</span><span class="n">param</span> <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">params</span> <span class="k">if</span> <span class="n">param</span><span class="o">.</span><span class="n">writeable</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">write</span> <span class="o">=</span> <span class="n">Message</span><span class="o">.</span><span class="n">NO_PARAMS</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">param</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">write_block</span><span class="p">,</span> <span class="n">param</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">params</span><span class="p">}</span></div>

<div class="viewcode-block" id="DeviceBuffer.get_update"><a class="viewcode-back" href="../../api-reference/buffer.html#runtime.buffer.DeviceBuffer.get_update">[docs]</a>    <span class="nd">@with_transaction</span>
    <span class="k">def</span> <span class="nf">get_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">/</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Get the parameters that were updated.</span>

<span class="sd">        Calling this method will clear the pending update map.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A map of parameter names to their corresponding values.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_from_bitmap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">update</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">update</span> <span class="o">=</span> <span class="n">Message</span><span class="o">.</span><span class="n">NO_PARAMS</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">param</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">param</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">params</span><span class="p">}</span></div>

<div class="viewcode-block" id="DeviceBuffer.update"><a class="viewcode-back" href="../../api-reference/buffer.html#runtime.buffer.DeviceBuffer.update">[docs]</a>    <span class="nd">@with_transaction</span>
    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span> <span class="n">Message</span><span class="p">,</span> <span class="o">/</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Digest a Smart Device message and update this buffer&#39;s state accordingly.</span>

<span class="sd">        The message&#39;s bitmaps and parameter values are copied into this buffer.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">message</span><span class="o">.</span><span class="n">type</span> <span class="ow">is</span> <span class="n">MessageType</span><span class="o">.</span><span class="n">DEV_DATA</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">update</span> <span class="o">|=</span> <span class="n">message</span><span class="o">.</span><span class="n">read_dev_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_update_param_map</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">last_update</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">message</span><span class="o">.</span><span class="n">type</span> <span class="ow">is</span> <span class="n">MessageType</span><span class="o">.</span><span class="n">DEV_READ</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">read</span> <span class="o">|=</span> <span class="n">message</span><span class="o">.</span><span class="n">read_dev_read</span><span class="p">()</span> <span class="o">&amp;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_mask</span>
        <span class="k">elif</span> <span class="n">message</span><span class="o">.</span><span class="n">type</span> <span class="ow">is</span> <span class="n">MessageType</span><span class="o">.</span><span class="n">DEV_WRITE</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">write</span> <span class="o">|=</span> <span class="n">message</span><span class="o">.</span><span class="n">read_dev_write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_write_param_map</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">last_write</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">message</span><span class="o">.</span><span class="n">type</span> <span class="ow">is</span> <span class="n">MessageType</span><span class="o">.</span><span class="n">SUB_REQ</span><span class="p">:</span>
            <span class="n">subscription</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">interval</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">read_sub_req</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">subscription</span> <span class="o">=</span> <span class="n">subscription</span> <span class="o">&amp;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_mask</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">interval</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">interval</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">interval_spec</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">interval</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">interval</span> <span class="o">=</span> <span class="n">interval</span>
        <span class="k">elif</span> <span class="n">message</span><span class="o">.</span><span class="n">type</span> <span class="ow">is</span> <span class="n">MessageType</span><span class="o">.</span><span class="n">SUB_RES</span><span class="p">:</span>
            <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">subscription</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">interval</span><span class="p">,</span>
                <span class="n">uid</span><span class="p">,</span>
            <span class="p">)</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">read_sub_res</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">uid</span> <span class="o">=</span> <span class="n">DeviceUID</span><span class="p">(</span><span class="o">*</span><span class="n">uid</span><span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">uid</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Smart Device unique identifier.&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">transaction</span><span class="p">():</span>
            <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">uid</span><span class="p">)</span>

    <span class="nd">@uid</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">uid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uid</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="o">/</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">transaction</span><span class="p">():</span>
            <span class="n">uid_parts</span> <span class="o">=</span> <span class="n">DeviceUID</span><span class="o">.</span><span class="n">from_int</span><span class="p">(</span><span class="n">uid</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">uid</span><span class="o">.</span><span class="n">device_id</span> <span class="o">=</span> <span class="n">uid_parts</span><span class="o">.</span><span class="n">device_id</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">uid</span><span class="o">.</span><span class="n">year</span> <span class="o">=</span> <span class="n">uid_parts</span><span class="o">.</span><span class="n">year</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">uid</span><span class="o">.</span><span class="n">random</span> <span class="o">=</span> <span class="n">uid_parts</span><span class="o">.</span><span class="n">random</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">subscription</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">frozenset</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;The names of parameters subscribed to.&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">transaction</span><span class="p">():</span>
            <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_from_bitmap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">subscription</span><span class="p">)</span>
            <span class="k">return</span> <span class="nb">frozenset</span><span class="p">(</span><span class="n">param</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">params</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">last_write</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;The timestamp given by :func:`time.time` of the last write.&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">transaction</span><span class="p">():</span>
            <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">last_write</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">last_update</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;The timestamp given by :func:`time.time` of the last update.&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">transaction</span><span class="p">():</span>
            <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">last_update</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">interval</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;The subscription interval in seconds.&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">transaction</span><span class="p">():</span>
            <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">interval</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000</span></div>


<span class="n">NullDevice</span> <span class="o">=</span> <span class="n">DeviceBuffer</span><span class="o">.</span><span class="n">make_type</span><span class="p">(</span><span class="s1">&#39;null-device&#39;</span><span class="p">,</span> <span class="p">[])</span>
<span class="sd">&quot;&quot;&quot;A buffer type with no parameters.</span>

<span class="sd">Useful for creating a non-null placeholder where a buffer is required.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="n">BufferKey</span> <span class="o">=</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span>
<span class="n">Catalog</span> <span class="o">=</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">type</span><span class="p">[</span><span class="n">Buffer</span><span class="p">]]</span>


<div class="viewcode-block" id="BufferStore"><a class="viewcode-back" href="../../api-reference/buffer.html#runtime.buffer.BufferStore">[docs]</a><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">BufferStore</span><span class="p">(</span><span class="n">collections</span><span class="o">.</span><span class="n">abc</span><span class="o">.</span><span class="n">Mapping</span><span class="p">[</span><span class="n">BufferKey</span><span class="p">,</span> <span class="n">Buffer</span><span class="p">]):</span>
    <span class="sd">&quot;&quot;&quot;Manage the lifecycle of a collection of buffers.</span>

<span class="sd">    Every device type has a unique name and every device has an integer identifier</span>
<span class="sd">    (UID) unique among its type. A type name and UID pair uniquely identifies a device</span>
<span class="sd">    globally. For Smart Devices, the UID encodes the type, so its UID alone specifies</span>
<span class="sd">    a buffer.</span>

<span class="sd">    A :class:`BufferStore` maps type name and UID pairs to buffer instances. The store</span>
<span class="sd">    implements the context manager protocol for automatically closing all open buffers.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        catalog: A device catalog mapping unique type names to buffer types. The</span>
<span class="sd">            buffer types should be generated with the :meth:`Buffer.make_type` factory.</span>
<span class="sd">        buffers: A mapping from type name and UID pairs to buffer instances.</span>
<span class="sd">        stack: An exit stack for closing buffers.</span>
<span class="sd">        shared: Whether buffers should be created shared memory.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">catalog</span><span class="p">:</span> <span class="n">Catalog</span>
    <span class="n">buffers</span><span class="p">:</span> <span class="n">MutableMapping</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="n">Buffer</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
    <span class="n">stack</span><span class="p">:</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">ExitStack</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="n">contextlib</span><span class="o">.</span><span class="n">ExitStack</span><span class="p">)</span>
    <span class="n">shared</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">device_ids</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="nb">repr</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">/</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">device_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_device_ids</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_make_device_ids</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">/</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
        <span class="n">device_ids</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">type_name</span><span class="p">,</span> <span class="n">buf_type</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">catalog</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">device_id</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">buf_type</span><span class="p">,</span> <span class="s1">&#39;device_id&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">device_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">device_id</span> <span class="ow">in</span> <span class="n">device_ids</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">DeviceBufferError</span><span class="p">(</span>
                        <span class="s1">&#39;duplicate Smart Device ID&#39;</span><span class="p">,</span>
                        <span class="n">device_id</span><span class="o">=</span><span class="n">device_id</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="n">device_ids</span><span class="p">[</span><span class="n">device_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">type_name</span>
        <span class="k">return</span> <span class="n">device_ids</span>

    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">/</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;BufferStore&#39;</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="fm">__enter__</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">exc_type</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">type</span><span class="p">[</span><span class="ne">BaseException</span><span class="p">]],</span>
        <span class="n">exc</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="ne">BaseException</span><span class="p">],</span>
        <span class="n">traceback</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">types</span><span class="o">.</span><span class="n">TracebackType</span><span class="p">],</span>
        <span class="o">/</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="fm">__exit__</span><span class="p">(</span><span class="n">exc_type</span><span class="p">,</span> <span class="n">exc</span><span class="p">,</span> <span class="n">traceback</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="n">BufferKey</span><span class="p">,</span> <span class="o">/</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Buffer</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_or_open</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">create</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">/</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">BufferKey</span><span class="p">]:</span>
        <span class="k">return</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buffers</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">/</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buffers</span><span class="p">)</span>

<div class="viewcode-block" id="BufferStore.normalize_key"><a class="viewcode-back" href="../../api-reference/buffer.html#runtime.buffer.BufferStore.normalize_key">[docs]</a>    <span class="k">def</span> <span class="nf">normalize_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="n">BufferKey</span><span class="p">,</span> <span class="o">/</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Convert a Smart Device UID into the type name and UID format.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The type name and UID pair.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">uid</span> <span class="o">=</span> <span class="n">DeviceUID</span><span class="o">.</span><span class="n">from_int</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">device_ids</span><span class="p">[</span><span class="n">uid</span><span class="o">.</span><span class="n">device_id</span><span class="p">],</span> <span class="n">key</span>
        <span class="k">return</span> <span class="n">key</span></div>

    <span class="nd">@typing</span><span class="o">.</span><span class="n">overload</span>
    <span class="k">def</span> <span class="nf">get_or_open</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="o">/</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">create</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="o">...</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DeviceBuffer</span><span class="p">:</span>
        <span class="o">...</span>

    <span class="nd">@typing</span><span class="o">.</span><span class="n">overload</span>
    <span class="k">def</span> <span class="nf">get_or_open</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="o">/</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">create</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="o">...</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Buffer</span><span class="p">:</span>
        <span class="o">...</span>

<div class="viewcode-block" id="BufferStore.get_or_open"><a class="viewcode-back" href="../../api-reference/buffer.html#runtime.buffer.BufferStore.get_or_open">[docs]</a>    <span class="k">def</span> <span class="nf">get_or_open</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="n">BufferKey</span><span class="p">,</span> <span class="o">/</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">create</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Buffer</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get a buffer, opening a new one if necessary.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            key: A buffer identifier.</span>
<span class="sd">            create: Whether to create a new buffer if one does not already exist.</span>

<span class="sd">        Raises:</span>
<span class="sd">            KeyError: The device ID or type name does not exist.</span>
<span class="sd">            DeviceBufferError: If ``create=False``, but the buffer does not exist.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">type_name</span><span class="p">,</span> <span class="n">uid</span> <span class="o">=</span> <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalize_key</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="n">buffer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">buffer</span><span class="p">:</span>
            <span class="n">buf_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">catalog</span><span class="p">[</span><span class="n">type_name</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">shared</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;rt-</span><span class="si">{</span><span class="n">type_name</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">uid</span><span class="si">}</span><span class="s1">&#39;</span>
                <span class="n">buffer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">enter_context</span><span class="p">(</span><span class="n">buf_type</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">create</span><span class="o">=</span><span class="n">create</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">create</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">DeviceBufferError</span><span class="p">(</span>
                        <span class="s1">&#39;local buffer not found&#39;</span><span class="p">,</span>
                        <span class="nb">type</span><span class="o">=</span><span class="n">type_name</span><span class="p">,</span>
                        <span class="n">uid</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">uid</span><span class="p">),</span>
                    <span class="p">)</span>
                <span class="n">buffer</span> <span class="o">=</span> <span class="n">buf_type</span><span class="o">.</span><span class="n">attach</span><span class="p">()</span>
                <span class="n">buffer</span><span class="o">.</span><span class="n">valid</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">buffers</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">buffer</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stack</span><span class="o">.</span><span class="n">callback</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buffers</span><span class="o">.</span><span class="n">pop</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">buffer</span></div>

<div class="viewcode-block" id="BufferStore.unlink_all"><a class="viewcode-back" href="../../api-reference/buffer.html#runtime.buffer.BufferStore.unlink_all">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">unlink_all</span><span class="p">(</span><span class="n">shm_path</span><span class="p">:</span> <span class="n">Path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s1">&#39;/dev/shm&#39;</span><span class="p">))</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Unlink all shared buffers owned by Runtime.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">shm_path</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;rt-*&#39;</span><span class="p">):</span>
            <span class="n">Buffer</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">name</span><span class="p">)</span></div>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_make_params</span><span class="p">(</span><span class="n">attrs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">Parameter</span><span class="p">]:</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">attrs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;params&#39;</span><span class="p">,</span> <span class="p">[])):</span>
            <span class="n">param</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>
            <span class="n">param</span><span class="p">[</span><span class="s1">&#39;ctype&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Parameter</span><span class="o">.</span><span class="n">parse_ctype</span><span class="p">(</span><span class="n">param</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">))</span>
            <span class="k">yield</span> <span class="n">Parameter</span><span class="p">(</span><span class="o">**</span><span class="n">param</span><span class="p">)</span>

<div class="viewcode-block" id="BufferStore.make_catalog"><a class="viewcode-back" href="../../api-reference/buffer.html#runtime.buffer.BufferStore.make_catalog">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">make_catalog</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">catalog</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">Catalog</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Generate buffer types from the raw peripheral specification.</span>

<span class="sd">        The raw peripheral specification follows this form::</span>

<span class="sd">            {</span>
<span class="sd">                &quot;device_id&quot;: &lt;int&gt;,             # For Smart Devices only</span>
<span class="sd">                &quot;sub_interval&quot;: &lt;float&gt;,          # Optional</span>
<span class="sd">                &quot;write_interval&quot;: &lt;float&gt;,        # Optional</span>
<span class="sd">                &quot;heartbeat_interval&quot;: &lt;float&gt;,    # Optional</span>
<span class="sd">                &quot;params&quot;: [</span>
<span class="sd">                    # Keyword arguments of ``Parameter``</span>
<span class="sd">                    {&quot;name&quot;: &lt;str&gt;, &quot;type&quot;: &lt;str&gt;}</span>
<span class="sd">                ]</span>
<span class="sd">            }</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">catalog_types</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">type_name</span><span class="p">,</span> <span class="n">attrs</span> <span class="ow">in</span> <span class="n">catalog</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">params</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_make_params</span><span class="p">(</span><span class="n">attrs</span><span class="p">))</span>
            <span class="n">base_type</span> <span class="o">=</span> <span class="n">DeviceBuffer</span> <span class="k">if</span> <span class="s1">&#39;device_id&#39;</span> <span class="ow">in</span> <span class="n">attrs</span> <span class="k">else</span> <span class="n">Buffer</span>
            <span class="n">catalog_types</span><span class="p">[</span><span class="n">type_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">base_type</span><span class="o">.</span><span class="n">make_type</span><span class="p">(</span><span class="n">type_name</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="o">**</span><span class="n">attrs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">catalog_types</span></div></div>
</pre></div>

          </div>
          <div class="page-nav">
            <div class="inner"><ul class="page-nav">
</ul><div class="footer" role="contentinfo">
      &#169; Copyright 2021, Pioneers in Engineering.
    <br>
    Created using <a href="http://sphinx-doc.org/">Sphinx</a> 4.2.0 with <a href="https://github.com/schettino72/sphinx_press_theme">Press Theme</a> 0.8.0.
</div>
            </div>
          </div>
      </page>
    </div></div>
    
    
  </body>
</html>